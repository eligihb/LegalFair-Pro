<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>×¨×™×©×•× ××ª×¢× ×™×™× ×™× â€“ ×™×¨×™×“ ××ª××—×™×- 2025 PRO</title>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
/* Reset and Base Styles */
*{box-sizing:border-box;}
:root{
  /* Enhanced Color Palette */
  --color-primary: #047857; /* Emerald 700 - Main Brand Color */
  --color-primary-dark: #065f46; /* Emerald 800 */
  --color-primary-light: #d1fae5; /* Emerald 100 */
  --color-secondary: #4b5563; /* Gray 600 */
  --color-bg: #f3f4f6; /* Light Gray */
  --color-text: #1f2937; /* Dark Gray (for readability) */
  --color-border: #e5e7eb;
  --radius-xl: 16px;
  --shadow-card: 0 6px 16px rgba(15,23,42,.12);
  --shadow-header: 0 4px 14px rgba(0,0,0,.2);
}

body{
  font-family:'Heebo',sans-serif;
  margin:0;
  padding:0;
  background:var(--color-bg);
  color:var(--color-text);
  line-height:1.5;
}

.page{
  max-width:560px; /* Slightly wider for modern mobile views */
  margin:0 auto;
  padding: 10px;
}

/* --- Header Bar --- */
.header-bar{
  background:var(--color-primary);
  color:#fff;
  padding:15px 18px;
  border-radius:var(--radius-xl);
  box-shadow:var(--shadow-header);
  margin-bottom:15px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.header-info{
  flex-grow:1;
  padding-left:10px;
}
.header-bar-title{
  font-size:1.2rem;
  font-weight:700;
  margin-bottom:2px;
}
.header-bar-sub{
  font-size:.8rem;
  opacity:.9;
  font-weight:300;
}
.header-actions{
  display:flex;
  flex-direction:column;
  gap:6px;
}
.header-actions button{
  border:none;
  border-radius:999px;
  font-size:.75rem;
  padding:6px 12px;
  cursor:pointer;
  transition:background .2s;
  font-weight:600;
}
.btn-open-records{
  background:#fff;
  color:var(--color-primary);
}
.btn-open-records:hover{background:#e5e7eb;}
.btn-admin{
  background:#b45309; /* Amber 700 */
  color:#fff;
}
.btn-admin:hover{background:#9a3412;} /* Red-ish for serious action */

/* --- Card Style --- */
.card{
  background:#fff;
  border-radius:var(--radius-xl);
  padding:16px;
  box-shadow:var(--shadow-card);
  margin-bottom:15px;
}

.card-title{
  font-weight:700;
  font-size:1.05rem;
  margin-bottom:12px;
  color:var(--color-primary-dark);
  text-align:center;
}

hr{
  border:none;
  border-top:1px dashed var(--color-border);
  margin:15px 0;
}

/* --- Form Elements --- */
label{
  font-weight:600;
  font-size:.9rem;
  margin-bottom:4px;
  display:block;
  color:var(--color-text);
}

input,select,textarea{
  width:100%;
  padding:10px 12px;
  font-size:.95rem;
  border-radius:10px;
  border:1px solid var(--color-border);
  background:#fff;
  margin-bottom:12px;
  transition:border-color .2s, box-shadow .2s;
  font-family:inherit;
}

input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:var(--color-primary);
  box-shadow:0 0 0 3px var(--color-primary-light);
}

textarea{
  resize:vertical;
  min-height:80px;
}

/* Short/Long Rows (Mobile Layout) */
.row-2{
  display:flex;
  gap:10px;
}
.row-2 .col{
  flex:1 1 0;
}

/* --- Messages --- */
.msg-box{
  min-height:1.3em;
  font-size:.8rem;
  margin:4px 0 10px;
}
.msg-box span{
  display:inline-block;
  padding:5px 12px;
  border-radius:999px;
  font-weight:500;
}
.msg-info span{background:#ecfdf5;color:#047857; border:1px solid #a7f3d0;}
.msg-warn span{background:#fffbeb;color:#b45309; border:1px solid #fcd34d;}
.msg-error span{background:#fef2f2;color:#b91c1c; border:1px solid #fca5a5;}

/* --- Buttons --- */
.btn{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
  margin-bottom:8px;
  transition:background .2s;
}
.btn-main{
  background:var(--color-primary);
  color:#fff;
}
.btn-main:hover{background:var(--color-primary-dark);}
.btn-secondary{
  background:var(--color-secondary);
  color:#fff;
}
.btn-secondary:hover{background:#374151;}

/* --- Star Rating --- */
.stars{
  display:flex;
  gap:6px;
  margin-bottom:12px;
}
.star{
  font-size:1.6rem;
  cursor:pointer;
  color:#d1d5db; /* Gray 300 */
  transition:color .2s;
}
.star.active{
  color:#fcd34d; /* Amber 300 */
}

/* --- Trait Chips --- */
.traits-container{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-bottom:12px;
}
.trait-chip{
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--color-border);
  font-size:.85rem;
  background:#f9fafb;
  cursor:pointer;
  transition:background .2s, border-color .2s, color .2s;
  font-weight:500;
}
.trait-chip.active{
  background:var(--color-primary);
  color:#fff;
  border-color:var(--color-primary);
}

/* Edit Status */
.edit-status{
  font-size:.85rem;
  color:#dc2626; /* Red 600 */
  text-align:center;
  min-height:1.2em;
  margin-bottom:8px;
  font-weight:600;
}

/* --- Record List (Mobile Table) --- */
.records-card-title{
  font-weight:700;
  font-size:.95rem;
  margin-bottom:6px;
  color:var(--color-text);
}

.record-list{
  margin-top:10px;
}

.record-row{
  background:#fff;
  border-radius:12px;
  padding:10px 12px;
  margin-bottom:10px;
  border:1px solid var(--color-border);
  box-shadow:0 1px 4px rgba(15,23,42,.08);
  cursor:pointer;
  transition:border-color .2s, background .2s;
}
.record-row:hover{
  background:#f9fafb;
  border-color:#d1d5db;
}

.record-row-top{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:8px;
}
.record-row-main{
  display:flex;
  flex-direction:column;
  gap:3px;
  flex-grow:1;
}

.record-line1{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
  font-size:1rem;
  font-weight:600;
  color:#047857; /* Highlight Name */
}
.record-name{
  max-width:60%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  color:#1f2937;
}
.record-tag{
  font-size:.7rem;
  padding:3px 9px;
  border-radius:999px;
  background:#e0f2fe; /* Sky 100 */
  color:#0369a1; /* Sky 700 */
  font-weight:500;
}
.record-line2,
.record-line3{
  display:flex;
  justify-content:space-between;
  font-size:.8rem;
  color:var(--color-secondary);
}

.record-details{
  font-size:.85rem;
  color:#374151;
  border-top:1px solid #f3f4f6; /* Lighter separator */
  margin-top:6px;
  padding-top:6px;
  display:none;
}
.record-meta-label{
  font-weight:600;
  color:#1f2937;
}

.record-removed{
  border-color:#fecaca;
  background:#fef2f2;
}

/* Edit/Delete Buttons */
.record-buttons{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.icon-btn{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:1.1rem;
  padding:4px;
  transition:opacity .2s;
}
.icon-btn:hover{opacity:0.7;}
.icon-btn.delete{
  color:#b91c1c;
}

/* Error State */
.input-error{
  border-color:#f97373 !important;
  box-shadow:0 0 0 3px #fee2e2 !important;
  background:#fef2f2;
}

/* --- Screens (Table View) --- */
.screen{
  display:none;
}
.screen.active{
  display:block;
}

/* Table */
.back-btn{
  margin-bottom:10px;
  padding:10px 14px;
  border-radius:999px;
  border:none;
  background:var(--color-primary);
  color:#fff;
  font-size:.9rem;
  cursor:pointer;
  font-weight:600;
  transition:background .2s;
}
.back-btn:hover{background:var(--color-primary-dark);}

/* Full Table for Records Screen */
.table-wrapper{
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:.75rem;
  background:#fff;
  min-width:700px; /* Ensure wide enough for all columns */
}
th,td{
  border:1px solid var(--color-border);
  padding:6px 8px;
  text-align:right;
}
th{
  background:#eff6ff; /* Blue 50 */
  font-weight:600;
  color:#1f2937;
}
tr.deleted-row{
  background:#fef2f2;
  color:#b91c1c;
  opacity:0.8;
}

/* Small Mobile Adjustments */
@media (max-width:400px){
  .header-actions button{font-size:.7rem;}
  .header-bar-title{font-size:1.1rem;}
  .record-line1{font-size:.95rem;}
  .record-line2, .record-line3{flex-direction:column;align-items:flex-start;gap:2px;}
}
</style>
</head>
<body>

<div class="page">

  <div id="screenForm" class="screen active">
    <div class="header-bar">
      <div class="header-info">
        <div class="header-bar-title">×¨×™×©×•× ××ª×¢× ×™×™× ×™× â€“ ×™×¨×™×“ ××ª××—×™× â­</div>
        <div class="header-bar-sub">××•×ª×× ×œ× ×¦×™×’×™× ×‘×©×˜×— â€“ ××”×™×¨, ×™×“×™×“×•×ª×™ ×•××¡×•×“×¨</div>
      </div>
      <div class="header-actions">
        <button class="btn-open-records" type="button" id="openRecordsBtn">ğŸ“„ ×¤×ª×— ×¨×©×•××•×ª</button>
        <button class="btn-admin" type="button" id="adminBtn">ğŸ”‘ × ×™×”×•×œ / ×™×™×¦×•×</button>
      </div>
    </div>

    <div class="card">
      <div class="card-title">ğŸ“ ×¤×¨×˜×™ ××•×§×“ ×•× ×¦×™×’</div>

      <label for="center">××•×§×“ *</label>
      <select id="center">
        <option value="">×‘×—×¨ ××•×§×“</option>
        <option>××•× ×™×‘×¨×¡×™×˜×ª ×ª"×</option>
        <option>××•× ×™×‘×¨×¡×™×˜×ª ×”×¢×‘×¨×™×ª</option>
        <option>××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ</option>
        <option>××›×œ×œ×ª ×¡×¤×™×¨</option>
        <option>×”××›×œ×œ×” ×œ×× ×”×œ</option>
        <option>××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜</option>
        <option>××—×¨</option>
      </select>

      <label for="agent">×©× × ×¦×™×’ *</label>
      <input id="agent" type="text" placeholder="×©× ××œ×">

      <hr>

      <div class="card-title">ğŸ‘¤ ×¤×¨×˜×™ ×”××ª×¢× ×™×™×Ÿ</div>

      <div class="row-2">
        <div class="col">
          <label for="name">×©× ××ª×¢× ×™×™×Ÿ</label>
          <input id="name" type="text" placeholder="×œ×“×•×’××”: ×“× ×” ×›×”×Ÿ">
        </div>
        <div class="col">
          <label for="year">×©× ×ª ×œ×™××•×“</label>
          <select id="year">
            <option value="">×‘×—×¨ ×©× ×”</option>
            <option>×©× ×” ×'</option>
            <option>×©× ×” ×‘'</option>
            <option>×©× ×” ×’'</option>
            <option>×©× ×” ×“'</option>
            <option>×¡×˜××–'</option>
          </select>
        </div>
      </div>

      <div class="row-2">
        <div class="col">
          <label for="city">×¢×™×¨ ××’×•×¨×™×</label>
          <input id="city" type="text" placeholder="×œ×“×•×’××”: × ×ª× ×™×”">
        </div>
        <div class="col">
          <label for="phone">×˜×œ×¤×•×Ÿ</label>
          <input id="phone" type="tel" placeholder="050-0000000">
        </div>
      </div>

      <label for="email">××™×™×œ</label>
      <input id="email" type="email" placeholder="example@mail.com">

      <label for="field">×ª×—×•× ××•×¢×“×£</label>
      <select id="field">
        <option value="">×‘×—×¨ ×ª×—×•×</option>
        <option>×œ×™×˜×™×’×¦×™×”</option>
        <option>××¡×—×¨×™ / ×ª××’×™×“×™</option>
        <option>× ×“×œ"×Ÿ</option>
        <option>×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</option>
        <option>×¢×‘×•×“×”</option>
        <option>× ×–×™×§×™×Ÿ</option>
        <option>××©×¤×—×”</option>
        <option>×¤×œ×™×œ×™</option>
        <option>××—×¨ / ×œ× ×‘×—×¨</option>
      </select>

      <label>â­ ×“×™×¨×•×’ ×›×œ×œ×™ (×¤×•×˜× ×¦×™××œ)</label>
      <div class="stars" id="stars">
        <span class="star" data-value="1">â˜…</span>
        <span class="star" data-value="2">â˜…</span>
        <span class="star" data-value="3">â˜…</span>
        <span class="star" data-value="4">â˜…</span>
        <span class="star" data-value="5">â˜…</span>
      </div>

      <label>ğŸ¯ ×××¤×™×™× ×™× ×‘×•×œ×˜×™× (×¨×™×‘×•×™ ×‘×—×™×¨×”)</label>
      <div class="traits-container" id="traitsContainer">
        <button type="button" class="trait-chip" data-trait="×—×¨×™×¦×•×ª">×—×¨×™×¦×•×ª</button>
        <button type="button" class="trait-chip" data-trait="××§×¦×•×¢×™×•×ª">××§×¦×•×¢×™×•×ª</button>
        <button type="button" class="trait-chip" data-trait="× ×™×¡×™×•×Ÿ">× ×™×¡×™×•×Ÿ ×¨×œ×•×•× ×˜×™</button>
        <button type="button" class="trait-chip" data-trait="×©×¤×” ×¢×©×™×¨×”">×©×¤×” ×¢×©×™×¨×”</button>
        <button type="button" class="trait-chip" data-trait="×›×¨×™×–××˜×™">×›×¨×™×–××˜×™</button>
        <button type="button" class="trait-chip" data-trait="××¡×¨×˜×™×‘×™">××¡×¨×˜×™×‘×™</button>
        <button type="button" class="trait-chip" data-trait="×‘×™×˜×—×•×Ÿ ×¢×¦××™">×‘×™×˜×—×•×Ÿ ×¢×¦××™</button>
        <button type="button" class="trait-chip" data-trait="×™×›×•×œ×ª × ×™×¡×•×—">×™×›×•×œ×ª × ×™×¡×•×—</button>
      </div>

      <label for="impression">ğŸ’­ ×”×ª×¨×©××•×ª ×›×œ×œ×™×ª</label>
      <textarea id="impression" placeholder="×ª×—×•×©×” ×›×œ×œ×™×ª, ×—×•×–×§×•×ª, × ×§×•×“×•×ª ×œ×©×™××•×¨ / ×œ×©×™×¤×•×¨..."></textarea>

      <label for="notes">ğŸ“ ×”×¢×¨×•×ª / ××¢×§×‘</label>
      <textarea id="notes" placeholder="×œ××©×œ: ×œ×§×‘×•×¢ ×©×™×—×” ×‘×©×‘×•×¢ ×”×‘×, ×œ×©×œ×•×— ×“×•×’××ª ×¤×¡×´×§, ××•×¢××“ ×¤×•×˜× ×¦×™××œ×™ ×œ××—×–×•×¨ ×”×‘× ×•×¢×•×“."></textarea>

      <div class="msg-box" id="msgBox"></div>
      <div class="edit-status" id="editStatus"></div>

      <button class="btn btn-main" id="mainBtn" type="button">âœ… ×”×•×¡×£ ×œ×¨×©×™××”</button>
      <button class="btn btn-secondary" id="clearBtn" type="button">ğŸ—‘ï¸ × ×§×” ×©×“×•×ª ××ª×¢× ×™×™×Ÿ</button>
    </div>

    <div class="card">
      <div class="records-card-title">×¨×©×•××•×ª ×©× ×©××¨×• ğŸ’¡</div>
      <small style="font-size:.7rem;color:#6b7280; display:block; margin-bottom: 5px;">×›×œ × ×¦×™×’ ×¨×•××” ×¨×§ ××ª ×”×¨×©×•××•×ª ×©×”×–×™×Ÿ ××”××›×©×™×¨ ×©×œ×•. (× ×©××¨ ×‘×–×™×›×¨×•×Ÿ ×”×“×¤×“×¤×Ÿ)</small>

      <div class="record-list" id="recordList"></div>
    </div>
  </div>

  <div id="screenRecords" class="screen">
    <button class="back-btn" type="button" id="backBtn">â¬…ï¸ ×—×–×¨×” ×œ×˜×•×¤×¡</button>

    <div class="card">
      <div class="card-title">×˜×‘×œ×ª ×¨×©×•××•×ª ××œ××” (××›×©×™×¨ × ×•×›×—×™)</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>××•×§×“</th>
              <th>× ×¦×™×’</th>
              <th>×ª××¨×™×š</th>
              <th>×©×¢×”</th>
              <th>×©×</th>
              <th>×˜×œ×¤×•×Ÿ</th>
              <th>××™×™×œ</th>
              <th>×ª×—×•×</th>
              <th>×“×™×¨×•×’</th>
              <th>×××¤×™×™× ×™×</th>
              <th>×”×ª×¨×©××•×ª</th>
              <th>×”×¢×¨×•×ª</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// ===== ×”×’×“×¨×•×ª â€“ × × ×œ×©× ×•×ª ×›××Ÿ! =====
// ×œ×›××Ÿ ×ª×›× ×™×¡ ××ª ×”-Apps Script ×©×œ×š (POST JSON):
const API_URL = 'https://script.google.com/macros/s/XXXXXXXXXXXX/exec'; // *** ×”×—×œ×£ URL ×–×”! ***
// ×§×•×“ × ×™×”×•×œ ×¤×©×•×˜ ×œ×™×™×¦×•×/×¡× ×›×¨×•×Ÿ ×™×“× ×™ (×ª×•×›×œ ×œ×©× ×•×ª):
const ADMIN_CODE = '1234'; // *** ×”×—×œ×£ ×§×•×“ ×–×”! ***

// ===== ×œ×•×’×™×§×ª ×§×•×“ (×©××™×¨×”, ×¢×¨×™×›×”, ×¡× ×›×¨×•×Ÿ) â€“ ××™×Ÿ ×¦×•×¨×š ×œ×©× ×•×ª! =====

const STORAGE_KEY = 'lfp_records_v3';
const HEADER_KEYÂ  = 'lfp_header_v3';
const OWNER_KEYÂ  Â = 'lfp_owner_id_v1';

let records = [];
let editingIndex = null;
let ownerId = null;
let currentRating = 0;

// === ×¢×–×¨ ===
const E = id => document.getElementById(id);

// ===== ×‘×¢×œ×™× (owner) ×œ×›×œ ×“×¤×“×¤×Ÿ =====
function initOwner(){
  ownerId = localStorage.getItem(OWNER_KEY);
  if(!ownerId){
    ownerId = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
    localStorage.setItem(OWNER_KEY, ownerId);
  }
}

// ===== ×”×•×“×¢×•×ª ×¨×›×•×ª =====
function showMsg(text,type='info'){
  const box = E('msgBox');
  box.className = 'msg-box msg-' + type;
  box.innerHTML = text ? `<span>${text}</span>` : '';
  if(text){
    // ×”×¡×ª×¨ ××•×˜×•××˜×™×ª ×”×•×“×¢×•×ª Info/Warn ××—×¨×™ 4 ×©× ×™×•×ª
    if(type !== 'error'){
      setTimeout(()=>{box.innerHTML='';},4000);
    }
  }
}

// ===== ×©××™×¨×ª ×›×•×ª×¨×ª (××•×§×“+× ×¦×™×’) =====
function saveHeader(){
  const header = {
    center:E('center').value,
    agent:E('agent').value
  };
  try{
    localStorage.setItem(HEADER_KEY,JSON.stringify(header));
  }catch(e){}
}

function loadHeader(){
  try{
    const h = localStorage.getItem(HEADER_KEY);
    if(h){
      const header = JSON.parse(h);
      if(header.center) E('center').value = header.center;
      if(header.agent)Â  E('agent').valueÂ  = header.agent;
    }
  }catch(e){}
}

// ===== localStorage ×©×œ ×¨×©×•××•×ª =====
function loadRecords(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const all = JSON.parse(raw) || [];
      // ×‘×¢×¦× ×× ×—× ×• ×©×•××¨×™× ×”×›×œ ××§×•××™×ª, ××‘×œ ××¦×™×’×™× ×¨×§ ××ª ×”×¨×©×•××•×ª ×©×œ ×”-ownerId ×”× ×•×›×—×™.
      // ×–×” ×©×•××¨ ×¢×œ ×”×œ×•×’×™×§×” ×”××§×•×¨×™×ª ×©×œ×š.
      records = all.filter(r=>r.ownerId === ownerId);
    }
  }catch(e){
    records = [];
  }
  renderRecords();
  renderTable();
}

function saveRecords(){
  // ×”×œ×•×’×™×§×” ×©×œ×š ×©××¨×” ×¨×§ ××ª ×”×¨×©×•××•×ª ×©×œ ×”-ownerId ×”× ×•×›×—×™, ××” ×©××•××¨ ×©-records ××›×™×œ ×¨×§ ××•×ª×Ÿ.
  try{
    localStorage.setItem(STORAGE_KEY,JSON.stringify(records));
  }catch(e){}
}

// ===== ×›×•×›×‘×™× =====
function setRating(val){
  currentRating = val;
  const stars = document.querySelectorAll('#stars .star');
  stars.forEach(st=>{
    const v = +st.dataset.value;
    st.classList.toggle('active', v <= val);
  });
}

// ===== ×¦×³×™×¤×™× =====
function getSelectedTraits(){
  return Array.from(document.querySelectorAll('.trait-chip.active'))
    .map(ch=>ch.dataset.trait);
}
function setSelectedTraits(list){
  const set = new Set(list||[]);
  document.querySelectorAll('.trait-chip').forEach(ch=>{
    ch.classList.toggle('active', set.has(ch.dataset.trait));
  });
}

// ===== ×©×“×•×ª ×©×’×•×™×™× =====
function clearInputErrors(){
  ['center','agent','name','phone'].forEach(id=>{
    E(id).classList.remove('input-error');
  });
}

// ===== ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ××”×¨×©×•××” =====
function getFormData(){
  return {
    center:E('center').value.trim(),
    agent:E('agent').value.trim(),
    name:E('name').value.trim(),
    year:E('year').value.trim(),
    city:E('city').value.trim(),
    phone:E('phone').value.trim(),
    email:E('email').value.trim(),
    field:E('field').value.trim(),
    rating:currentRating || 0,
    traits:getSelectedTraits(),
    impression:E('impression').value.trim(),
    notes:E('notes').value.trim()
  };
}

function setFormData(data){
  E('center').value = data.center || '';
  E('agent').valueÂ  = data.agent || '';
  E('name').valueÂ  Â = data.name || '';
  E('year').valueÂ  Â = data.year || '';
  E('city').valueÂ  Â = data.city || '';
  E('phone').valueÂ  = data.phone || '';
  E('email').valueÂ  = data.email || '';
  E('field').valueÂ  = data.field || '';
  E('impression').value = data.impression || '';
  E('notes').valueÂ  = data.notes || '';
  setRating(data.rating || 0);
  setSelectedTraits(data.traits || []);
  clearInputErrors(); // ×œ× ×§×•×ª ×©×’×™××•×ª ×‘×¢×ª ×˜×¢×™× ×ª ×¨×©×•××” ×œ×¢×¨×™×›×”
}

function resetPersonFields(){
  ['name','year','city','phone','email','field','impression','notes'].forEach(id=>{
    E(id).value='';
  });
  setRating(0);
  setSelectedTraits([]);
  clearInputErrors();
}

// ===== ×¡× ×›×¨×•×Ÿ ×œ-Google Sheets (×¦×“ ×©×¨×ª ×‘-Apps Script) =====
async function syncRecord(rec,action){
  if(!API_URL || API_URL.includes('XXXXXXXXXXXX')) return; // Check if URL is placeholder
  try{
    const payload = {
      action,Â  Â // 'create' | 'update' | 'delete' | 'bulk'
      ownerId,
      record:rec,
      timestamp: new Date().toISOString() // Add server timestamp
    };
    await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    // ××¤×©×¨×•×ª ×œ×”×•×¡×™×£ ×›××Ÿ ×”×•×“×¢×ª ×”×¦×œ×—×” ×§×˜× ×” ×©× ×¡×’×¨×ª ××”×¨, ××‘×œ ×”×œ×•×’×™×§×” ×”××§×•×¨×™×ª ×œ× ×›×œ×œ×” ××•×ª×”.
  }catch(e){
    // ×œ× ××¤×™×œ ××ª ×”×××©×§, ×¨×§ ×”×•×“×¢×” ×¨×›×”
    console.error('Sync Error:',e);
    // showMsg('×©×’×™××ª ×¡× ×›×¨×•×Ÿ: ×œ× × ×™×ª×Ÿ ×œ×©×œ×•×— × ×ª×•× ×™× ×œ-Google Sheets.','error');
  }
}

async function syncAllAsAdmin(){
  if(!API_URL || API_URL.includes('XXXXXXXXXXXX')){
     alert('×©×’×™××”: × × ×œ×”×’×“×™×¨ ××ª API_URL ×‘×§×•×“.');
     return;
  }
  const code = prompt('× × ×œ×”×–×™×Ÿ ×§×•×“ ××•×¨×©×” (×§×•×“: '+ADMIN_CODE+')'); // show code as a hint
  if(code !== ADMIN_CODE){
    alert('×§×•×“ ×©×’×•×™.');
    return;
  }
  try{
    const payload = {
      action:'bulk',
      ownerId,
      records: records, // ×©×•×œ×—×™× ×¨×§ ××ª ×”×¨×©×•××•×ª ×©×œ ×”××©×ª××© ×”× ×•×›×—×™
      timestamp: new Date().toISOString()
    };
    const res = await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    const result = await res.json();
    if(result.status === 'success'){
      alert('âœ… ×”×¡× ×›×¨×•×Ÿ × ×©×œ×— ×‘×”×¦×œ×—×” ×œ-Google Sheets (× ×©×œ×—×• '+records.length+' ×¨×©×•××•×ª).');
    } else {
       alert('âŒ ××™×¨×¢×” ×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ. × × ×œ×‘×“×•×§ ××ª ×”-Apps Script. ×©×’×™××”: ' + (result.message || '×œ× ×™×“×•×¢'));
    }
  }catch(e){
    alert('âŒ ××™×¨×¢×” ×©×’×™××” ×›×œ×œ×™×ª ×‘×©×œ×™×—×ª ×”×¡× ×›×¨×•×Ÿ.');
  }
}

// ===== ×”×•×¡×¤×” / ×¢×“×›×•×Ÿ =====
async function handleSave(){
  clearInputErrors();
  const data = getFormData();

  // ×—×•×‘×”: ××•×§×“ + × ×¦×™×’
  let hasError=false;
  if(!data.center){
    E('center').classList.add('input-error');
    hasError=true;
  }
  if(!data.agent){
    E('agent').classList.add('input-error');
    hasError=true;
  }
  if(hasError){
    showMsg('× × ×œ××œ× ××•×§×“ ×•×©× × ×¦×™×’ (×©×“×•×ª ×—×•×‘×”).','error');
    return;
  }

  // ××–×”×¨×” ×¨×›×” ×× ××™×Ÿ ×©× ×•×’× ××™×Ÿ ×˜×œ×¤×•×Ÿ
  let isWarn = false;
  if(!data.name && !data.phone){
    E('name').classList.add('input-error');
    E('phone').classList.add('input-error');
    showMsg('âš ï¸ ×œ× ×”×•×–× ×• ×©× ××ª×¢× ×™×™×Ÿ ×•×˜×œ×¤×•×Ÿ. ××•××œ×¥ ×œ×”×©×œ×™× ×œ×¤×—×•×ª ××—×“ ××”×.', 'warn');
    isWarn = true;
  } else {
    if(!isWarn) showMsg(''); // Clear msg only if no initial error/warn
  }

  // ×ª××¨×™×š ×•×©×¢×” ××•×˜×•××˜×™×™×
  const now = new Date();
  data.date = now.toLocaleDateString('he-IL');
  data.time = now.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
  data.ownerId = ownerId;
  data.deleted = false;

  saveHeader();

  let action = 'create';
  if(editingIndex !== null){
    // Update existing record
    records[editingIndex] = data;
    action = 'update';
  }else{
    // Add new record
    records.push(data);
  }

  saveRecords();
  renderRecords();
  renderTable();

  // Reset only the person-specific fields, keep center/agent for quick repeat entry
  resetPersonFields(); 
  
  E('mainBtn').textContent='âœ… ×”×•×¡×£ ×œ×¨×©×™××”';
  E('editStatus').textContent='';
  editingIndex=null;

  if(!isWarn) showMsg('âœ… ×”×¨×©×•××” × ×©××¨×” ×‘×”×¦×œ×—×”.','info');

  syncRecord(data,action); // ×©×œ×™×—×” ×œ-Google Sheets
}

// ===== ××—×™×§×” =====
async function deleteRecord(idx){
  const rec = records[idx];
  if(!rec || rec.ownerId !== ownerId) return; // safety check
  
  if(editingIndex === idx){
    // ×× ××•×—×§×™× ××ª ×”×¨×©×•××” ×©× ×¢×¨×›×ª
    E('clearBtn').click(); // ×™× ×§×” ××ª ×”×˜×•×¤×¡ ×•×™×¦× ×××¦×‘ ×¢×¨×™×›×”
  }
  
  const ok = confirm('âš ï¸ ×œ××—×•×§ ×¨×©×•××” ×–×•? (××¦×œ×š ×ª×•×¡×¨ ××”×¨×©×™××”; ×‘×’×™×œ×™×•×Ÿ ×”×™× ×ª×¡×•××Ÿ ×›× ××—×§×”)');
  if(!ok) return;

  // ××¡×•××Ÿ ×›× ××—×§ ×œ×¦×•×¨×š ×¡× ×›×¨×•×Ÿ
  rec.deleted = true;
  
  // ×× ×—× ×• ××¡×™×¨×™× ××ª ×”×¨×©×•××” ××”×ª×¦×•×’×” ×”× ×•×›×—×™×ª ×•×××¢×¨×š ×”-records ×”××§×•××™.
  // ×”×œ×•×’×™×§×” ×©×©×œ×—×ª ×œ× ×¢×‘×“×” × ×›×•×Ÿ, ×–×” ×”×ª×™×§×•×Ÿ:
  records.splice(idx,1); 

  saveRecords(); 
  renderRecords();
  renderTable();
  
  syncRecord(rec,'delete');
}

// ===== ×¢×¨×™×›×” =====
function editRecord(idx){
  const rec = records[idx];
  if(!rec || rec.ownerId !== ownerId) return; // safety check
  setFormData(rec);
  editingIndex = idx;
  E('mainBtn').textContent='ğŸ”„ ×¢×“×›×•×Ÿ ×¨×©×•××”';
  E('editStatus').textContent='××¦×‘ ×¢×¨×™×›×”: ×¨×©×•××” #' + (idx+1);
  showScreen('screenForm'); // ×•×“× ×©×”××©×ª××© ×‘××¡×š ×”×˜×•×¤×¡
  showMsg('ğŸ“ ××ª×” ×¢×•×¨×š ×¨×©×•××” ×§×™×™××ª. ×œ××—×¨ ×¡×™×•× ×œ×—×¥ "×¢×“×›×•×Ÿ ×¨×©×•××”".','info');
}

// ===== ×”×¦×’×ª ×¨×©×•××•×ª â€“ ×›×¨×˜×™×¡×™×•×ª =====
function toggleDetails(idx){
  const d = E('details-'+idx);
  if(!d) return;
  d.style.display = d.style.display==='block' ? 'none' : 'block';
}

function ratingToStars(r){
  if(!r) return '';
  // ×©×™××•×© ×‘-â­ ×•×‘-â˜† ×œ×”×¤×¨×“×” ×•×™×–×•××œ×™×ª ×˜×•×‘×” ×™×•×ª×¨
  return 'â­'.repeat(r) + 'â˜†'.repeat(5-r);
}

function renderRecords(){
  const box = E('recordList');
  box.innerHTML='';

  if(!records.length){
    box.innerHTML='<div style="font-size:.8rem;color:#9ca3af;margin-top:4px; text-align:center;">×¢×“×™×™×Ÿ ××™×Ÿ ×¨×©×•××•×ª. ×”×ª×—×™×œ×• ×œ××œ× ×‘×˜×•×¤×¡ ×œ××¢×œ×”.</div>';
    return;
  }

  records.forEach((r,idx)=>{
    const row = document.createElement('div');
    row.className = 'record-row' + (r.deleted ? ' record-removed' : '');
    row.onclick = ()=>toggleDetails(idx);

    const traitsText = (r.traits && r.traits.length) ? r.traits.join(' Â· ') : 'â€”';
    const ownerCanEdit = (r.ownerId === ownerId) && !r.deleted; // ×œ× ×××¤×©×¨×™× ×¢×¨×™×›×”/××—×™×§×” ×©×œ ×¨×©×•××” ×©×›×‘×¨ ×¡×•×× ×” ×›× ××—×§×”

    row.innerHTML = `
      <div class="record-row-top">
        <div class="record-row-main">
          <div class="record-line1">
            <div class="record-name">${r.name || '(×œ×œ× ×©×)'}</div>
            <div class="record-tag">${r.field || '×œ×œ× ×ª×—×•×'}</div>
          </div>
          <div class="record-line2">
            <span>${r.year || 'â€”'} ${r.city ? 'Â· '+r.city : ''}</span>
            <span>ğŸ“ ${r.phone || 'â€”'}</span>
          </div>
          <div class="record-line3">
            <span>ğŸ“ ${r.center || ''}</span>
            <span>ğŸ™‹ ${r.agent || ''}</span>
            <span>ğŸ“… ${r.date || ''} ${r.time || ''}</span>
          </div>
        </div>
        <div class="record-buttons">
          ${ownerCanEdit ? `<button class="icon-btn" type="button" title="×¢×¨×•×š" onclick="event.stopPropagation();editRecord(${idx})">âœï¸</button>` : ''}
          ${ownerCanEdit ? `<button class="icon-btn delete" type="button" title="××—×§" onclick="event.stopPropagation();deleteRecord(${idx})">ğŸ—‘ï¸</button>` : ''}
        </div>
      </div>
      <div class="record-details" id="details-${idx}">
        <div><span class="record-meta-label">×“×™×¨×•×’:</span> ${ratingToStars(r.rating)}</div>
        <div><span class="record-meta-label">×××¤×™×™× ×™×:</span> ${traitsText}</div>
        <div><span class="record-meta-label">××™×™×œ:</span> ${r.email || 'â€”'}</div>
        <div><span class="record-meta-label">×”×ª×¨×©××•×ª:</span> ${r.impression || 'â€”'}</div>
        <div><span class="record-meta-label">×”×¢×¨×•×ª:</span> ${r.notes || 'â€”'}</div>
        ${(!r.name && !r.phone) ? `<div style="color:#b45309;font-size:.75rem;margin-top:2px;">â— ×”×¢×¨×”: ××™×Ÿ ×©×/×˜×œ×¤×•×Ÿ â€“ ××•××œ×¥ ×œ×”×©×œ×™× ×‘×”××©×š.</div>` : ''}
      </div>
    `;
    box.appendChild(row);
  });
}

// ===== ×˜×‘×œ×ª ×¨×©×•××•×ª ×‘××¡×š × ×¤×¨×“ =====
function renderTable(){
  const tbody = E('tableBody');
  if(!tbody) return;
  tbody.innerHTML='';
  records.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    if(r.deleted) tr.classList.add('deleted-row');
    const traitsText = (r.traits && r.traits.length) ? r.traits.join(', ') : '';
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${r.center||''}</td>
      <td>${r.agent||''}</td>
      <td>${r.date||''}</td>
      <td>${r.time||''}</td>
      <td>${r.name||''}</td>
      <td>${r.phone||''}</td>
      <td>${r.email||''}</td>
      <td>${r.field||''}</td>
      <td>${r.rating||''}</td>
      <td>${traitsText}</td>
      <td>${(r.impression||'').replace(/[\r\n]+/g,' ')}</td>
      <td>${(r.notes||'').replace(/[\r\n]+/g,' ')}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== ××¡×›×™× =====
function showScreen(name){
  ['screenForm','screenRecords'].forEach(id=>{
    E(id).classList.remove('active');
  });
  E(name).classList.add('active');
}

// ===== ×”××–× ×•×ª =====
E('mainBtn').addEventListener('click',handleSave);
E('clearBtn').addEventListener('click',()=>{
  resetPersonFields();
  editingIndex=null;
  E('mainBtn').textContent='âœ… ×”×•×¡×£ ×œ×¨×©×™××”';
  E('editStatus').textContent='';
  showMsg('');
});
E('openRecordsBtn').addEventListener('click',()=>showScreen('screenRecords'));
E('backBtn').addEventListener('click',()=>showScreen('screenForm'));
E('adminBtn').addEventListener('click',syncAllAsAdmin);

// ×›×•×›×‘×™×
document.querySelectorAll('#stars .star').forEach(st=>{
  st.addEventListener('click',()=>{
    const v = +st.dataset.value;
    setRating(v);
  });
});

// ×¦×³×™×¤×™×
document.querySelectorAll('.trait-chip').forEach(ch=>{
  ch.addEventListener('click',()=>{
    ch.classList.toggle('active');
  });
});

// ×©××™×¨×ª ×›×•×ª×¨×ª ×‘×›×œ ×©×™× ×•×™
['center','agent'].forEach(id=>{
  E(id).addEventListener('change',saveHeader);
});

// ===== ××ª×—×•×œ =====
initOwner();
loadHeader();
loadRecords();
setRating(0); // Set initial rating to 0 (no stars)
</script>

</body>
</html>
