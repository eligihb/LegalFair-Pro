<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>×¨×™×©×•× ××ª×¢× ×™×™× ×™× â€“ ×™×¨×™×“ ××ª××—×™×</title>

<link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box;}

body{
  font-family:'Heebo',sans-serif;
  margin:0;
  padding:10px;
  background:#f3f4f6;
  color:#111827;
}

.page{
  max-width:520px;
  margin:0 auto;
}

/* ×‘×¨ ×¢×œ×™×•×Ÿ */
.header-bar{
  background:#0f766e;
  color:#fff;
  padding:10px 14px;
  border-radius:14px;
  box-shadow:0 4px 14px rgba(0,0,0,.15);
  margin-bottom:10px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:8px;
}
.header-bar-title{
  font-size:1.05rem;
  font-weight:700;
}
.header-bar-sub{
  font-size:.78rem;
  opacity:.9;
}
.header-actions{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.header-actions button{
  border:none;
  border-radius:999px;
  font-size:.78rem;
  padding:4px 10px;
  cursor:pointer;
}
.btn-open-records{
  background:#f9fafb;
  color:#0f766e;
}
.btn-open-records:hover{background:#e5f3f2;}
.btn-admin{
  background:#78350f;
  color:#fff;
}
.btn-admin:hover{background:#92400e;}

/* ×›×¨×˜×™×¡×™× */
.card{
  background:#fff;
  border-radius:14px;
  padding:12px;
  box-shadow:0 4px 12px rgba(15,23,42,.08);
  margin-bottom:12px;
}

.card-title{
  font-weight:700;
  font-size:.95rem;
  margin-bottom:6px;
  color:#0f766e;
  text-align:center;
}

/* ×˜×•×¤×¡ */
label{
  font-weight:600;
  font-size:.85rem;
  margin-bottom:2px;
  display:block;
}

input,select,textarea{
  width:100%;
  padding:9px 10px;
  font-size:.95rem;
  border-radius:10px;
  border:1px solid #d1d5db;
  background:#f9fafb;
  margin-bottom:10px;
}

input:focus,select:focus,textarea:focus{
  outline:none;
  border-color:#0f766e;
  box-shadow:0 0 0 2px rgba(15,118,110,.12);
}

textarea{
  resize:vertical;
  min-height:70px;
}

/* ×©×•×¨×•×ª ×§×¦×¨×•×ª / ××¨×•×›×•×ª */
.row-2{
  display:flex;
  gap:8px;
}
.row-2 .col{
  flex:1 1 0;
}

/* ×”×•×“×¢×•×ª */
.msg-box{
  min-height:1.3em;
  font-size:.8rem;
  margin:2px 0 6px;
}
.msg-box span{
  display:inline-block;
  padding:3px 8px;
  border-radius:999px;
}
.msg-info span{background:#e0f2fe;color:#075985;}
.msg-warn span{background:#fef9c3;color:#92400e;}
.msg-error span{background:#fee2e2;color:#991b1b;}

/* ×›×¤×ª×•×¨×™× */
.btn{
  width:100%;
  padding:11px;
  border-radius:10px;
  border:none;
  font-size:1rem;
  font-weight:700;
  cursor:pointer;
  margin-bottom:6px;
}
.btn-main{
  background:#0d9488;
  color:#fff;
}
.btn-main:hover{background:#0f766e;}
.btn-secondary{
  background:#6b7280;
  color:#fff;
}
.btn-secondary:hover{background:#4b5563;}

/* ×“×™×¨×•×’ ×›×•×›×‘×™× */
.stars{
  display:flex;
  gap:4px;
  margin-bottom:8px;
}
.star{
  font-size:1.3rem;
  cursor:pointer;
  color:#d1d5db;
}
.star.active{
  color:#facc15;
}

/* ×¦×³×™×¤×™× ×©×œ ×××¤×™×™× ×™× */
.traits-container{
  display:flex;
  flex-wrap:wrap;
  gap:6px;
  margin-bottom:8px;
}
.trait-chip{
  padding:4px 9px;
  border-radius:999px;
  border:1px solid #e5e7eb;
  font-size:.8rem;
  background:#f9fafb;
  cursor:pointer;
}
.trait-chip.active{
  background:#0f766e;
  color:#fff;
  border-color:#0f766e;
}

/* ×©×•×¨×ª ××¦×‘ ×¢×¨×™×›×” */
.edit-status{
  font-size:.8rem;
  color:#b91c1c;
  text-align:center;
  min-height:1.2em;
  margin-bottom:4px;
}

/* ×¨×©×™××ª ×¨×©×•××•×ª â€“ "×˜×‘×œ×” ××•×‘×™×™×œ×™×ª" */
.records-card-title{
  font-weight:700;
  font-size:.9rem;
  margin-bottom:4px;
  color:#111827;
}

.record-list{
  margin-top:6px;
}

.record-row{
  background:#f9fafb;
  border-radius:10px;
  padding:8px 10px;
  margin-bottom:10px;
  border:1px solid #e5e7eb;
  box-shadow:0 1px 3px rgba(15,23,42,.06);
  cursor:pointer;
}
.record-row-main{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.record-row-top{
  display:flex;
  align-items:flex-start;
  justify-content:space-between;
  gap:4px;
}
.record-line1{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:6px;
  font-size:.9rem;
  font-weight:600;
}
.record-name{
  max-width:55%;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.record-tag{
  font-size:.75rem;
  padding:2px 8px;
  border-radius:999px;
  background:#ecfeff;
  color:#0f766e;
}
.record-line2,
.record-line3{
  display:flex;
  justify-content:space-between;
  font-size:.78rem;
  color:#4b5563;
}

.record-details{
  font-size:.8rem;
  color:#374151;
  border-top:1px dashed #e5e7eb;
  margin-top:4px;
  padding-top:4px;
  display:none;
}
.record-meta-label{
  font-weight:600;
}

.record-removed{
  border-color:#fecaca;
  background:#fef2f2;
}

/* ×›×¤×ª×•×¨×™ ×¢×¨×™×›×”/××—×™×§×” */
.record-buttons{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.icon-btn{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:1.1rem;
  padding:0 0 0 4px;
}
.icon-btn.delete{
  color:#b91c1c;
}

/* ×©×’×™××” ×‘×©×“×” */
.input-error{
  border-color:#f97373 !important;
  background:#fef2f2;
}

/* ××¡×š ×¨×©×•××•×ª (×˜×‘×œ×” ××œ××”) */
.screen{
  display:none;
}
.screen.active{
  display:block;
}

/* ×˜×‘×œ×ª ×¨×©×•××•×ª */
.table-wrapper{
  overflow-x:auto;
}
table{
  width:100%;
  border-collapse:collapse;
  font-size:.8rem;
  background:#fff;
}
th,td{
  border:1px solid #e5e7eb;
  padding:4px 6px;
  text-align:right;
}
th{
  background:#eef2ff;
  font-weight:600;
}
tr.deleted-row{
  background:#fef2f2;
  color:#b91c1c;
}

.back-btn{
  margin-bottom:8px;
  padding:8px 10px;
  border-radius:999px;
  border:none;
  background:#0f766e;
  color:#fff;
  font-size:.85rem;
  cursor:pointer;
}

/* ××•×‘×™×™×œ ×§×˜×Ÿ */
@media (max-width:360px){
  .record-line2,
  .record-line3{flex-direction:column;align-items:flex-start;gap:2px;}
}
</style>
</head>
<body>

<div class="page">

  <!-- ××¡×š: ×˜×•×¤×¡ -->
  <div id="screenForm" class="screen active">
    <div class="header-bar">
      <div>
        <div class="header-bar-title">×¨×™×©×•× ××ª×¢× ×™×™× ×™× â€“ ×™×¨×™×“ ××ª××—×™×</div>
        <div class="header-bar-sub">××•×ª×× ×œ× ×¦×™×’×™× ×‘×©×˜×— â€“ ××”×™×¨, ×™×“×™×“×•×ª×™ ×•××¡×•×“×¨</div>
      </div>
      <div class="header-actions">
        <button class="btn-open-records" type="button" id="openRecordsBtn">×¤×ª×— ×¨×©×•××•×ª</button>
        <button class="btn-admin" type="button" id="adminBtn">× ×™×”×•×œ / ×™×™×¦×•× (×œ××•×¨×©×™× ×‘×œ×‘×“)</button>
      </div>
    </div>

    <!-- ×˜×•×¤×¡ -->
    <div class="card">
      <div class="card-title">×¤×¨×˜×™ ××•×§×“ ×•× ×¦×™×’</div>

      <label for="center">××•×§×“ *</label>
      <select id="center">
        <option value="">×‘×—×¨ ××•×§×“</option>
        <option>××•× ×™×‘×¨×¡×™×˜×ª ×ª"×</option>
        <option>××•× ×™×‘×¨×¡×™×˜×ª ×”×¢×‘×¨×™×ª</option>
        <option>××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ</option>
        <option>××›×œ×œ×ª ×¡×¤×™×¨</option>
        <option>×”××›×œ×œ×” ×œ×× ×”×œ</option>
        <option>××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜</option>
      </select>

      <label for="agent">×©× × ×¦×™×’ *</label>
      <input id="agent" type="text" placeholder="×©× ××œ×">

      <hr>

      <div class="card-title" style="margin-top:4px;">×¤×¨×˜×™ ×”××ª×¢× ×™×™×Ÿ</div>

      <div class="row-2">
        <div class="col">
          <label for="name">×©× ××ª×¢× ×™×™×Ÿ</label>
          <input id="name" type="text" placeholder="×œ×“×•×’××”: ×“× ×” ×›×”×Ÿ">
        </div>
        <div class="col">
          <label for="year">×©× ×”</label>
          <select id="year">
            <option value="">×‘×—×¨ ×©× ×”</option>
            <option>×©× ×” ×'</option>
            <option>×©× ×” ×‘'</option>
            <option>×©× ×” ×’'</option>
            <option>×©× ×” ×“'</option>
            <option>×¡×˜××–'</option>
          </select>
        </div>
      </div>

      <div class="row-2">
        <div class="col">
          <label for="city">×¢×™×¨</label>
          <input id="city" type="text" placeholder="×œ×“×•×’××”: × ×ª× ×™×”">
        </div>
        <div class="col">
          <label for="phone">×˜×œ×¤×•×Ÿ</label>
          <input id="phone" type="tel" placeholder="050-0000000">
        </div>
      </div>

      <label for="email">××™×™×œ</label>
      <input id="email" type="email" placeholder="example@mail.com">

      <label for="field">×ª×—×•× ××•×¢×“×£</label>
      <select id="field">
        <option value="">×‘×—×¨ ×ª×—×•×</option>
        <option>×œ×™×˜×™×’×¦×™×”</option>
        <option>××¡×—×¨×™</option>
        <option>×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</option>
        <option>×¢×‘×•×“×”</option>
        <option>× ×–×™×§×™×Ÿ</option>
        <option>××©×¤×—×”</option>
        <option>×¤×œ×™×œ×™</option>
      </select>

      <!-- ×“×™×¨×•×’ ×›×•×›×‘×™× -->
      <label>×“×™×¨×•×’ ×›×œ×œ×™</label>
      <div class="stars" id="stars">
        <span class="star" data-value="1">â˜…</span>
        <span class="star" data-value="2">â˜…</span>
        <span class="star" data-value="3">â˜…</span>
        <span class="star" data-value="4">â˜…</span>
        <span class="star" data-value="5">â˜…</span>
      </div>

      <!-- ×¦×³×™×¤×™× ×©×œ ×××¤×™×™× ×™× -->
      <label>×××¤×™×™× ×™× ×‘×•×œ×˜×™×</label>
      <div class="traits-container" id="traitsContainer">
        <button type="button" class="trait-chip" data-trait="×—×¨×™×¦×•×ª">×—×¨×™×¦×•×ª</button>
        <button type="button" class="trait-chip" data-trait="××§×¦×•×¢×™×•×ª">××§×¦×•×¢×™×•×ª</button>
        <button type="button" class="trait-chip" data-trait="× ×™×¡×™×•×Ÿ">× ×™×¡×™×•×Ÿ</button>
        <button type="button" class="trait-chip" data-trait="×©×¤×” ×¢×©×™×¨×”">×©×¤×” ×¢×©×™×¨×”</button>
        <button type="button" class="trait-chip" data-trait="×›×¨×™×–××˜×™">×›×¨×™×–××˜×™</button>
        <button type="button" class="trait-chip" data-trait="×•×¨×‘×œ×™">×•×¨×‘×œ×™</button>
        <button type="button" class="trait-chip" data-trait="×‘×™×˜×—×•×Ÿ ×¢×¦××™">×‘×™×˜×—×•×Ÿ ×¢×¦××™</button>
        <button type="button" class="trait-chip" data-trait="×™×›×•×œ×ª × ×™×¡×•×—">×™×›×•×œ×ª × ×™×¡×•×—</button>
      </div>

      <label for="impression">×”×ª×¨×©××•×ª ×›×œ×œ×™×ª</label>
      <textarea id="impression" placeholder="×ª×—×•×©×” ×›×œ×œ×™×ª, ×—×•×–×§×•×ª, × ×§×•×“×•×ª ×œ×©×™××•×¨ / ×œ×©×™×¤×•×¨..."></textarea>

      <label for="notes">×”×¢×¨×•×ª / ××¢×§×‘</label>
      <textarea id="notes" placeholder="×œ××©×œ: ×œ×§×‘×•×¢ ×©×™×—×” ×‘×©×‘×•×¢ ×”×‘×, ×œ×©×œ×•×— ×“×•×’××ª ×¤×¡×´×§, ××•×¢××“ ×¤×•×˜× ×¦×™××œ×™ ×œ××—×–×•×¨ ×”×‘× ×•×¢×•×“."></textarea>

      <div class="msg-box" id="msgBox"></div>
      <div class="edit-status" id="editStatus"></div>

      <button class="btn btn-main" id="mainBtn" type="button">×”×•×¡×£ ×œ×¨×©×™××”</button>
      <button class="btn btn-secondary" id="clearBtn" type="button">× ×§×” ×©×“×•×ª ××ª×¢× ×™×™×Ÿ</button>
    </div>

    <!-- ×¨×©×•××•×ª ××ª×—×ª ×œ×˜×•×¤×¡ -->
    <div class="card">
      <div class="records-card-title">×¨×©×•××•×ª ×©× ×©××¨×• (×‘×“×¤×“×¤×Ÿ ×©×œ×š)</div>
      <small style="font-size:.75rem;color:#6b7280;">×›×œ × ×¦×™×’ ×¨×•××” ×¨×§ ××ª ×”×¨×©×•××•×ª ×©×”×–×™×Ÿ ××”××›×©×™×¨ ×©×œ×•. ×ª××¨×™×š ×•×©×¢×” × ×©××¨×™× ××•×˜×•××˜×™×ª.</small>

      <div class="record-list" id="recordList"></div>
    </div>
  </div>

  <!-- ××¡×š: ×¨×©×•××•×ª ×‘×˜×‘×œ×” -->
  <div id="screenRecords" class="screen">
    <button class="back-btn" type="button" id="backBtn">â† ×—×–×¨×” ×œ×˜×•×¤×¡</button>

    <div class="card" style="margin-top:4px;">
      <div class="card-title">×˜×‘×œ×ª ×¨×©×•××•×ª (×”××›×©×™×¨ ×”× ×•×›×—×™)</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>××•×§×“</th>
              <th>× ×¦×™×’</th>
              <th>×ª××¨×™×š</th>
              <th>×©×¢×”</th>
              <th>×©×</th>
              <th>×˜×œ×¤×•×Ÿ</th>
              <th>××™×™×œ</th>
              <th>×ª×—×•×</th>
              <th>×“×™×¨×•×’</th>
              <th>×××¤×™×™× ×™×</th>
              <th>×”×ª×¨×©××•×ª</th>
              <th>×”×¢×¨×•×ª</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script>
// ===== ×”×’×“×¨×•×ª =====

// ×œ×›××Ÿ ×ª×›× ×™×¡ ××ª ×”-Apps Script ×©×œ×š (POST JSON):
const API_URL = 'https://script.google.com/macros/s/XXXXXXXXXXXX/exec';
// ×§×•×“ × ×™×”×•×œ ×¤×©×•×˜ ×œ×™×™×¦×•×/×¡× ×›×¨×•×Ÿ ×™×“× ×™ (×ª×•×›×œ ×œ×©× ×•×ª):
const ADMIN_CODE = '1234';

const STORAGE_KEY = 'lfp_records_v3';
const HEADER_KEY  = 'lfp_header_v3';
const OWNER_KEY   = 'lfp_owner_id_v1';

let records = [];
let editingIndex = null;
let ownerId = null;
let currentRating = 0;

// === ×¢×–×¨ ===
const E = id => document.getElementById(id);

// ===== ×‘×¢×œ×™× (owner) ×œ×›×œ ×“×¤×“×¤×Ÿ =====
function initOwner(){
  ownerId = localStorage.getItem(OWNER_KEY);
  if(!ownerId){
    ownerId = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
    localStorage.setItem(OWNER_KEY, ownerId);
  }
}

// ===== ×”×•×“×¢×•×ª ×¨×›×•×ª =====
function showMsg(text,type='info'){
  const box = E('msgBox');
  box.className = 'msg-box msg-' + type;
  box.innerHTML = text ? `<span>${text}</span>` : '';
  if(text){
    setTimeout(()=>{box.innerHTML='';},4000);
  }
}

// ===== ×©××™×¨×ª ×›×•×ª×¨×ª (××•×§×“+× ×¦×™×’) =====
function saveHeader(){
  const header = {
    center:E('center').value,
    agent:E('agent').value
  };
  try{
    localStorage.setItem(HEADER_KEY,JSON.stringify(header));
  }catch(e){}
}

function loadHeader(){
  try{
    const h = localStorage.getItem(HEADER_KEY);
    if(h){
      const header = JSON.parse(h);
      if(header.center) E('center').value = header.center;
      if(header.agent)  E('agent').value  = header.agent;
    }
  }catch(e){}
}

// ===== localStorage ×©×œ ×¨×©×•××•×ª =====
function loadRecords(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const all = JSON.parse(raw) || [];
      records = all.filter(r=>r.ownerId === ownerId);
    }
  }catch(e){
    records = [];
  }
  renderRecords();
  renderTable();
}

function saveRecords(){
  try{
    localStorage.setItem(STORAGE_KEY,JSON.stringify(records));
  }catch(e){}
}

// ===== ×›×•×›×‘×™× =====
function setRating(val){
  currentRating = val;
  const stars = document.querySelectorAll('#stars .star');
  stars.forEach(st=>{
    const v = +st.dataset.value;
    st.classList.toggle('active', v <= val);
  });
}

// ===== ×¦×³×™×¤×™× =====
function getSelectedTraits(){
  return Array.from(document.querySelectorAll('.trait-chip.active'))
    .map(ch=>ch.dataset.trait);
}
function setSelectedTraits(list){
  const set = new Set(list||[]);
  document.querySelectorAll('.trait-chip').forEach(ch=>{
    ch.classList.toggle('active', set.has(ch.dataset.trait));
  });
}

// ===== ×©×“×•×ª ×©×’×•×™×™× =====
function clearInputErrors(){
  ['center','agent','name','phone'].forEach(id=>{
    E(id).classList.remove('input-error');
  });
}

// ===== ×™×¦×™×¨×ª ××•×‘×™×™×§×˜ ××”×¨×©×•××” =====
function getFormData(){
  return {
    center:E('center').value.trim(),
    agent:E('agent').value.trim(),
    name:E('name').value.trim(),
    year:E('year').value.trim(),
    city:E('city').value.trim(),
    phone:E('phone').value.trim(),
    email:E('email').value.trim(),
    field:E('field').value.trim(),
    rating:currentRating || 0,
    traits:getSelectedTraits(),
    impression:E('impression').value.trim(),
    notes:E('notes').value.trim()
  };
}

function setFormData(data){
  E('center').value = data.center || '';
  E('agent').value  = data.agent || '';
  E('name').value   = data.name || '';
  E('year').value   = data.year || '';
  E('city').value   = data.city || '';
  E('phone').value  = data.phone || '';
  E('email').value  = data.email || '';
  E('field').value  = data.field || '';
  E('impression').value = data.impression || '';
  E('notes').value  = data.notes || '';
  setRating(data.rating || 0);
  setSelectedTraits(data.traits || []);
}

function resetPersonFields(){
  ['name','year','city','phone','email','field','impression','notes'].forEach(id=>{
    E(id).value='';
  });
  setRating(0);
  setSelectedTraits([]);
  clearInputErrors();
}

// ===== ×¡× ×›×¨×•×Ÿ ×œ-Google Sheets (×¦×“ ×©×¨×ª ×‘-Apps Script) =====
async function syncRecord(rec,action){
  if(!API_URL) return;
  try{
    const payload = {
      action,   // 'create' | 'update' | 'delete' | 'bulk'
      ownerId,
      record:rec
    };
    await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
  }catch(e){
    // ×œ× ××¤×™×œ ××ª ×”×××©×§, ×¨×§ ×”×•×“×¢×” ×¨×›×”
    console.log('sync error',e);
  }
}

async function syncAllAsAdmin(){
  if(!API_URL) return;
  const code = prompt('× × ×œ×”×–×™×Ÿ ×§×•×“ ××•×¨×©×”');
  if(code !== ADMIN_CODE){
    alert('×§×•×“ ×©×’×•×™.');
    return;
  }
  try{
    const payload = {
      action:'bulk',
      ownerId,
      records
    };
    await fetch(API_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(payload)
    });
    alert('×”×¡× ×›×¨×•×Ÿ × ×©×œ×— ×œ-Google Sheets (×‘×”× ×—×” ×©×”×¡×§×¨×™×¤×˜ ××—×•×‘×¨).');
  }catch(e){
    alert('××™×¨×¢×” ×©×’×™××” ×‘×©×œ×™×—×ª ×”×¡× ×›×¨×•×Ÿ.');
  }
}

// ===== ×”×•×¡×¤×” / ×¢×“×›×•×Ÿ =====
async function handleSave(){
  clearInputErrors();
  const data = getFormData();

  // ×—×•×‘×”: ××•×§×“ + × ×¦×™×’
  let hasError=false;
  if(!data.center){
    E('center').classList.add('input-error');
    hasError=true;
  }
  if(!data.agent){
    E('agent').classList.add('input-error');
    hasError=true;
  }
  if(hasError){
    showMsg('× × ×œ××œ× ××•×§×“ ×•×©× × ×¦×™×’ (×©×“×•×ª ×—×•×‘×”).','error');
    return;
  }

  // ××–×”×¨×” ×¨×›×” ×× ××™×Ÿ ×©× ×•×’× ××™×Ÿ ×˜×œ×¤×•×Ÿ
  if(!data.name && !data.phone){
    E('name').classList.add('input-error');
    E('phone').classList.add('input-error');
    showMsg('×œ× ×”×•×–× ×• ×©× ××ª×¢× ×™×™×Ÿ ×•×˜×œ×¤×•×Ÿ. ××•××œ×¥ ×œ×”×©×œ×™× ×œ×¤×—×•×ª ××—×“ ××”×.', 'warn');
  }else{
    showMsg('');
  }

  // ×ª××¨×™×š ×•×©×¢×” ××•×˜×•××˜×™×™×
  const now = new Date();
  data.date = now.toLocaleDateString('he-IL');
  data.time = now.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'});
  data.ownerId = ownerId;
  data.deleted = false;

  saveHeader();

  let action = 'create';
  if(editingIndex !== null){
    records[editingIndex] = data;
    action = 'update';
  }else{
    records.push(data);
  }

  saveRecords();
  renderRecords();
  renderTable();
  resetPersonFields();

  E('mainBtn').textContent='×”×•×¡×£ ×œ×¨×©×™××”';
  E('editStatus').textContent='';
  editingIndex=null;

  syncRecord(data,action); // ×©×œ×™×—×” ×œ-Google Sheets
}

// ===== ××—×™×§×” =====
async function deleteRecord(idx){
  const rec = records[idx];
  if(!rec || rec.ownerId !== ownerId) return;
  const ok = confirm('×œ××—×•×§ ×¨×©×•××” ×–×•? (××¦×œ×š ×ª×•×¡×¨ ××”×¨×©×™××”; ×‘×’×™×œ×™×•×Ÿ ×”×™× ×ª×¡×•××Ÿ ×›× ××—×§×”)');
  if(!ok) return;

  // ××¡×•××Ÿ ×›× ××—×§ ×œ×¦×•×¨×š ×¡× ×›×¨×•×Ÿ; ××”×ª×¦×•×’×” ×× ×—× ×• ××¡×™×¨×™×
  rec.deleted = true;
  saveRecords(); // ×× ×ª×¨×¦×” ×œ× ×œ×©××•×¨ ××ª ×”××—×•×§×™× ××§×•××™×ª â€“ ××¤×©×¨ ×’× splice
  records.splice(idx,1);
  renderRecords();
  renderTable();
  syncRecord(rec,'delete');
}

// ===== ×¢×¨×™×›×” =====
function editRecord(idx){
  const rec = records[idx];
  if(!rec || rec.ownerId !== ownerId) return;
  setFormData(rec);
  editingIndex = idx;
  E('mainBtn').textContent='×¢×“×›×•×Ÿ ×¨×©×•××”';
  E('editStatus').textContent='××¦×‘ ×¢×¨×™×›×”: ×¨×©×•××” #' + (idx+1);
  showMsg('××ª×” ×¢×•×¨×š ×¨×©×•××” ×§×™×™××ª. ×œ××—×¨ ×¡×™×•× ×œ×—×¥ "×¢×“×›×•×Ÿ ×¨×©×•××”".','info');
}

// ===== ×”×¦×’×ª ×¨×©×•××•×ª â€“ ×›×¨×˜×™×¡×™×•×ª =====
function toggleDetails(idx){
  const d = E('details-'+idx);
  if(!d) return;
  d.style.display = d.style.display==='block' ? 'none' : 'block';
}

function ratingToStars(r){
  if(!r) return '';
  return 'â˜…'.repeat(r) + 'â˜†'.repeat(5-r);
}

function renderRecords(){
  const box = E('recordList');
  box.innerHTML='';

  if(!records.length){
    box.innerHTML='<div style="font-size:.8rem;color:#9ca3af;margin-top:4px;">××™×Ÿ ×¢×“×™×™×Ÿ ×¨×©×•××•×ª. ×”×ª×—×™×œ×• ×œ××œ× ×‘×˜×•×¤×¡ ×œ××¢×œ×”.</div>';
    return;
  }

  records.forEach((r,idx)=>{
    const row = document.createElement('div');
    row.className = 'record-row';
    row.onclick = ()=>toggleDetails(idx);

    const traitsText = (r.traits && r.traits.length) ? r.traits.join(' Â· ') : '×œ×œ×';
    const ownerCanEdit = (r.ownerId === ownerId);

    row.innerHTML = `
      <div class="record-row-top">
        <div class="record-row-main">
          <div class="record-line1">
            <div class="record-name">${r.name || '(×œ×œ× ×©×)'}</div>
            <div class="record-tag">${r.field || '×œ×œ× ×ª×—×•×'}</div>
          </div>
          <div class="record-line2">
            <span>${r.year || ''} ${r.city ? 'Â· '+r.city : ''}</span>
            <span>${r.phone || ''}</span>
          </div>
          <div class="record-line3">
            <span>${r.center || ''}</span>
            <span>${r.agent || ''}</span>
            <span>${r.date || ''} ${r.time || ''}</span>
          </div>
        </div>
        <div class="record-buttons">
          ${ownerCanEdit ? `<button class="icon-btn" type="button" onclick="event.stopPropagation();editRecord(${idx})">âœï¸</button>` : ''}
          ${ownerCanEdit ? `<button class="icon-btn delete" type="button" onclick="event.stopPropagation();deleteRecord(${idx})">ğŸ—‘ï¸</button>` : ''}
        </div>
      </div>
      <div class="record-details" id="details-${idx}">
        <div><span class="record-meta-label">×“×™×¨×•×’:</span> ${ratingToStars(r.rating)}</div>
        <div><span class="record-meta-label">×××¤×™×™× ×™×:</span> ${traitsText}</div>
        <div><span class="record-meta-label">×”×ª×¨×©××•×ª:</span> ${r.impression || 'â€”'}</div>
        <div><span class="record-meta-label">×”×¢×¨×•×ª:</span> ${r.notes || 'â€”'}</div>
        ${(!r.name && !r.phone) ? `<div style="color:#b91c1c;font-size:.75rem;margin-top:2px;">×”×¢×¨×”: ××™×Ÿ ×©×/×˜×œ×¤×•×Ÿ â€“ ××•××œ×¥ ×œ×”×©×œ×™× ×‘×”××©×š.</div>` : ''}
      </div>
    `;
    box.appendChild(row);
  });
}

// ===== ×˜×‘×œ×ª ×¨×©×•××•×ª ×‘××¡×š × ×¤×¨×“ =====
function renderTable(){
  const tbody = E('tableBody');
  if(!tbody) return;
  tbody.innerHTML='';
  records.forEach((r,idx)=>{
    const tr = document.createElement('tr');
    if(r.deleted) tr.classList.add('deleted-row');
    const traitsText = (r.traits && r.traits.length) ? r.traits.join(' Â· ') : '';
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td>${r.center||''}</td>
      <td>${r.agent||''}</td>
      <td>${r.date||''}</td>
      <td>${r.time||''}</td>
      <td>${r.name||''}</td>
      <td>${r.phone||''}</td>
      <td>${r.email||''}</td>
      <td>${r.field||''}</td>
      <td>${r.rating||''}</td>
      <td>${traitsText}</td>
      <td>${(r.impression||'').replace(/[\r\n]+/g,' ')}</td>
      <td>${(r.notes||'').replace(/[\r\n]+/g,' ')}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ===== ××¡×›×™× =====
function showScreen(name){
  ['screenForm','screenRecords'].forEach(id=>{
    E(id).classList.remove('active');
  });
  E(name).classList.add('active');
}

// ===== ×”××–× ×•×ª =====
E('mainBtn').addEventListener('click',handleSave);
E('clearBtn').addEventListener('click',()=>{
  resetPersonFields();
  editingIndex=null;
  E('mainBtn').textContent='×”×•×¡×£ ×œ×¨×©×™××”';
  E('editStatus').textContent='';
  showMsg('');
});
E('openRecordsBtn').addEventListener('click',()=>showScreen('screenRecords'));
E('backBtn').addEventListener('click',()=>showScreen('screenForm'));
E('adminBtn').addEventListener('click',syncAllAsAdmin);

// ×›×•×›×‘×™×
document.querySelectorAll('#stars .star').forEach(st=>{
  st.addEventListener('click',()=>{
    const v = +st.dataset.value;
    setRating(v);
  });
});

// ×¦×³×™×¤×™×
document.querySelectorAll('.trait-chip').forEach(ch=>{
  ch.addEventListener('click',()=>{
    ch.classList.toggle('active');
  });
});

// ×©××™×¨×ª ×›×•×ª×¨×ª ×‘×›×œ ×©×™× ×•×™
['center','agent'].forEach(id=>{
  E(id).addEventListener('change',saveHeader);
});

// ===== ××ª×—×•×œ =====
initOwner();
loadHeader();
loadRecords();
setRating(0);
</script>

</body>
</html>
