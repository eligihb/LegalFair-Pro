<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×¨×™×©×•× ××ª×¢× ×™×™× ×™×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ××•×ª×• ×¢×™×¦×•×‘ ×‘×“×™×•×§ */
    :root { --primary: #0f766e; --bg: #f3f4f6; --text: #111827; }
    body { margin: 0; padding: 10px; font-family: 'Heebo', sans-serif; background: var(--bg); color: var(--text); padding-bottom: 40px; }
    .shell { max-width: 550px; margin: 0 auto; }
    .stats-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 15px; border-radius: 12px; margin-bottom: 10px; font-weight: 600; color: var(--primary); }
    .top-bar { display: flex; gap: 8px; margin-bottom: 12px; }
    .top-btn { flex: 1; border: 1px solid #e5e7eb; background: white; padding: 8px; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; }
    .top-btn.main { background: var(--primary); color: white; }
    .top-btn.reset { background: #fef2f2; color: #b91c1c; border-color: #fca5a5; }
    .card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    .locked-header { display: none; background: #ecfdf5; border: 1px solid #10b981; border-radius: 12px; padding: 10px; align-items: center; justify-content: space-between; margin-bottom: 15px; }
    .btn-unlock { background: white; border: 1px solid #10b981; color: #059669; border-radius: 8px; padding: 4px 10px; font-size: 0.75rem; cursor: pointer; }
    .grid { display: grid; gap: 10px; } .grid-2 { grid-template-columns: 1fr 1fr; }
    input, select, textarea { width: 100%; border-radius: 12px; border: 1px solid #e5e7eb; padding: 10px; background: #f9fafb; }
    .section-title { margin: 15px 0 5px; font-weight: bold; color: var(--primary); border-bottom: 2px solid #f0fdfa; }
    .btn-main { width: 100%; border-radius: 999px; padding: 12px; font-weight: 700; background: var(--primary); color: white; border: none; margin-top: 20px; cursor: pointer; }
    .btn-sub { width: 100%; margin-top: 15px; background: transparent; color: #666; border: 1px solid #ddd; padding: 10px; border-radius: 999px; cursor: pointer; }
    .file-upload-wrapper { border: 2px dashed #cbd5e1; border-radius: 12px; text-align: center; padding: 15px; position: relative; }
    .file-upload-wrapper.has-file { border-style: solid; border-color: #10b981; background: #ecfdf5; }
    .file-upload-input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
    .msg { margin-top: 10px; padding: 10px; border-radius: 8px; display: none; text-align: center; }
    .msg-ok { background: #ecfdf5; color: #065f46; } .msg-err { background: #fef2f2; color: #991b1b; }
    #viewTable { display: none; }
    /* ×˜×‘×œ×” */
    .styled-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    .styled-table th { background: var(--primary); color: white; padding: 8px; }
    .styled-table td { border-bottom: 1px solid #ddd; padding: 8px; }
    .trait-chip { display:inline-block; padding:4px 10px; border:1px solid #ddd; border-radius:15px; margin:2px; cursor:pointer; }
    .trait-chip.active { background:var(--primary); color:white; }
    .stars { font-size: 1.5rem; cursor: pointer; color: #ddd; }
    .star.filled { color: #f59e0b; }
  </style>
</head>
<body>
<div class="shell">
  <div class="stats-bar">
    <div id="greeting">×©×œ×•×, × ×¦×™×’ ğŸ‘‹</div>
    <div>×¨×©×•××•×ª: <span id="totalCount">0</span></div>
  </div>
  <div class="top-bar">
    <button class="top-btn reset" onclick="clearForm(false)">ğŸ§¹ × ×§×” ×˜×•×¤×¡</button>
    <button class="top-btn" onclick="toggleView()">ğŸ“„ ×¨×©×•××•×ª</button>
    <button class="top-btn main" onclick="openAdmin()">ğŸ“Š ×’×™×œ×™×•×Ÿ</button>
  </div>

  <div id="viewForm">
    <div class="card">
      <div id="headerLocked" class="locked-header">
         <div><div id="lockedAgentName" style="font-weight:bold"></div><div id="lockedCenterName" style="font-size:0.8rem"></div></div>
         <button class="btn-unlock" onclick="unlockHeader()">âœï¸ ×©×™× ×•×™</button>
      </div>

      <div id="headerSetup">
          <div class="section-title">ğŸ“ ×¤×¨×˜×™ ××•×§×“</div>
          <div class="grid grid-2">
            <select id="center" onchange="onCenterChange()"><option value="">×‘×—×¨ ××•×§×“</option>
              <option>××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ</option><option>(×¡×™××•×œ×¦×™×™×ª ×©×•×ª×¤×™× ×œ×“×¨×š)</option><option>××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ</option><option>××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ-××‘×™×‘</option><option>××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜</option><option>×©×•×ª×¤×™× ×œ×“×¨×š</option><option>××›×œ×œ×ª ×¡×¤×™×¨</option><option>×”××›×œ×œ×” ×œ×× ×”×œ ×¨××©×œ"×¦</option><option>×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª</option>
            </select>
            <select id="agent"><option value="">×‘×—×¨ × ×¦×™×’</option></select>
          </div>
          <div class="grid" style="margin-top:5px"><input id="date" type="date"></div>
      </div>

      <div class="section-title">ğŸ“ ×¡×˜×•×“× ×˜</div>
      <div class="grid">
        <input id="name" placeholder="×©× ××œ×">
        <div class="grid grid-2">
          <select id="year"><option value="">×©× ×”...</option><option>×©× ×” ×'</option><option>×©× ×” ×‘'</option><option>×©× ×” ×’'</option><option>×©× ×” ×“'</option><option>×¡×˜××–'</option></select>
          <input id="city" placeholder="×¢×™×¨">
        </div>
        <div class="grid grid-2"><input id="phone" type="tel" placeholder="×˜×œ×¤×•×Ÿ"><input id="email" type="email" placeholder="××™×™×œ"></div>
        <select id="field"><option value="">×ª×—×•× ××•×¢×“×£...</option><option>×œ×™×˜×™×’×¦×™×”</option><option>××¡×—×¨×™</option><option>×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</option><option>×“×™× ×™ ×¢×‘×•×“×”</option><option>× ×–×™×§×™×Ÿ</option><option>××©×¤×—×”</option><option>×¤×œ×™×œ×™</option></select>
        
        <div class="grid grid-2">
           <div class="file-upload-wrapper" id="wrapCV"><input type="file" id="fileCV" class="file-upload-input" accept=".pdf,.doc,.docx" onchange="updFile('fileCV','wrapCV','×§×•×—')">ğŸ“„ <span id="lbl_fileCV">×§×•"×—</span></div>
           <div class="file-upload-wrapper" id="wrapImg"><input type="file" id="fileImg" class="file-upload-input" accept="image/*" onchange="updFile('fileImg','wrapImg','×ª××•× ×”')">ğŸ“· <span id="lbl_fileImg">×ª××•× ×”</span></div>
        </div>
      </div>

      <div class="section-title">â­ ×¡×™×›×•×</div>
      <div class="grid">
        <div>×“×™×¨×•×’: <span id="stars" class="stars"><span data-val="1" class="star">â˜…</span><span data-val="2" class="star">â˜…</span><span data-val="3" class="star">â˜…</span><span data-val="4" class="star">â˜…</span><span data-val="5" class="star">â˜…</span></span></div>
        <div id="traitsBox">
            <span class="trait-chip" onclick="this.classList.toggle('active')" data-t="×—×¨×™×¦×•×ª">×—×¨×™×¦×•×ª</span>
            <span class="trait-chip" onclick="this.classList.toggle('active')" data-t="××§×¦×•×¢×™×•×ª">××§×¦×•×¢×™×•×ª</span>
            <span class="trait-chip" onclick="this.classList.toggle('active')" data-t="×›×¨×™×–××˜×™">×›×¨×™×–××˜×™</span>
            <span class="trait-chip" onclick="this.classList.toggle('active')" data-t="×•×¨×‘×œ×™">×•×¨×‘×œ×™</span>
        </div>
        <textarea id="impression" placeholder="×”×ª×¨×©××•×ª"></textarea>
        <textarea id="notes" placeholder="×”×¢×¨×•×ª ×¤× ×™××™×•×ª"></textarea>
      </div>

      <button id="btnSave" class="btn-main" onclick="saveRecord()">ğŸ’¾ ×©××•×¨ ×¨×©×•××”</button>
      
      <button id="btnClear" class="btn-sub" onclick="clearForm(true)">×™×¦×™××” ×•××™×¤×•×¡ ×”×›×œ</button>

      <div id="msgOk" class="msg msg-ok"></div><div id="msgErr" class="msg msg-err"></div>
    </div>
  </div>

  <div id="viewTable" style="display:none; background:white; padding:15px; border-radius:15px;">
    <h3>×”×™×¡×˜×•×¨×™×”</h3>
    <table class="styled-table"><tbody id="tableBody"></tbody></table>
    <button class="btn-main" style="background:#666" onclick="toggleView()">×—×–×•×¨</button>
  </div>
</div>

<script>
// ×”×§×¤×“ ×œ×©×™× ×›××Ÿ ××ª ×”×§×™×©×•×¨ ×©×œ×š ××”×¤×¨×™×¡×”
const API_URL = 'https://script.google.com/macros/s/AKfycbwip8xRO6q99yg_iX5KRddVmv3suZmeCEQJ4_TGY4MVtENw3WcrDHUEnTUBI3D7KdE/exec'; 
const SHEET_LINK = 'https://docs.google.com/spreadsheets/d/1Oz32yNCobHdhz0APS4zl5O34rkqZxGvP0TJgPKKDLdk/edit';
const ADMIN_CODE = '2100';

const FAIR_SCHEDULE = [{ centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ",date:"2025-12-01",agents:["×™×¢×§×‘","××•×¤×™×¨","×©×§×“","×’×œ"] },{ centerName:"(×¡×™××•×œ×¦×™×™×ª ×©×•×ª×¤×™× ×œ×“×¨×š)",date:"2025-12-02",agents:["××•×¨×™","××™×ª×™ ×©×’×‘","×¦×™×•× ×”"] },{ centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ",date:"2025-12-03",agents:["××™×œ×•×Ÿ","×™×¢×§×‘","××œ×™××‘","×‘×™×¡××Ÿ"] },{ centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ-××‘×™×‘",date:"2025-12-04",agents:["××•×¨×™","××•×¤×™×¨","×¦×œ×™×œ"] },{ centerName:"××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜",date:"2025-12-08",agents:["××•×¨×™","××•×¤×™×¨","×¦×œ×™×œ"] },{ centerName:"×©×•×ª×¤×™× ×œ×“×¨×š",date:"2025-12-08",agents:["××™×ª×™*","×¦×™×•× ×”*"] },{ centerName:"××›×œ×œ×ª ×¡×¤×™×¨",date:"2025-12-09",agents:["×‘×§×™","××™×ª×™"] },{ centerName:"×”××›×œ×œ×” ×œ×× ×”×œ ×¨××©×œ\"×¦",date:"2025-12-25",agents:["××•×¨×™","×¦×™×•× ×”","××•×¤×™×¨"] },{ centerName:"×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª",date:"2025-12-28",agents:["××•×¨×™","××œ×™××‘"] }];

const E = id => document.getElementById(id);
let records=[], ownerId=localStorage.getItem('uid')||'u_'+Date.now(), currentRating=0;
localStorage.setItem('uid', ownerId);

function init(){
    // ×©×—×–×•×¨ ×©× × ×¦×™×’ ×•××•×§×“ ×× ×§×™×™××™× ×‘×–×™×›×¨×•×Ÿ
    const savedAgent = localStorage.getItem('last_agent');
    const savedCenter = localStorage.getItem('last_center');
    
    if(savedCenter){
        E('center').value = savedCenter;
        onCenterChange(); // ×˜×•×¢×Ÿ ××ª ×”× ×¦×™×’×™×
        if(savedAgent){
            E('agent').value = savedAgent;
            lockHeader(); // × ×•×¢×œ ××•×˜×•××˜×™×ª ×× ×™×© × ×ª×•× ×™×
        }
    }
    
    const raw=localStorage.getItem('recs'); if(raw) records=JSON.parse(raw);
    updCount();
}

// × ×™×”×•×œ ××•×§×“ ×•× ×¦×™×’
function lockHeader(){
    const a=E('agent').value, c=E('center').value;
    if(!a||!c)return;
    E('lockedAgentName').textContent = '× ×¦×™×’: '+a;
    E('lockedCenterName').textContent = c;
    E('headerSetup').style.display='none';
    E('headerLocked').style.display='flex';
    E('greeting').textContent = '×©×œ×•×, '+a;
    
    // ×©××™×¨×” ×‘×–×™×›×¨×•×Ÿ
    localStorage.setItem('last_agent', a);
    localStorage.setItem('last_center', c);
}

function unlockHeader(){
    E('headerLocked').style.display='none';
    E('headerSetup').style.display='block';
}

function onCenterChange(){
    const val = E('center').value;
    const slot = FAIR_SCHEDULE.find(s=>s.centerName===val);
    const sel = E('agent'); sel.innerHTML='<option value="">×‘×—×¨ × ×¦×™×’</option>';
    if(slot){
        E('date').value = slot.date;
        slot.agents.forEach(a=> sel.innerHTML+=`<option>${a.replace('*','')}</option>`);
    }
}

// × ×™×”×•×œ ×§×‘×¦×™×
function updFile(id, wrap, txt){
    const f=E(id).files[0];
    const el=E(wrap); const lbl=document.getElementById('lbl_'+id);
    if(f){ el.classList.add('has-file'); lbl.textContent=f.name.slice(0,10)+'...'; }
    else{ el.classList.remove('has-file'); lbl.textContent=txt; }
}

const file64 = f => new Promise(r=>{const rd=new FileReader(); rd.onload=()=>r({name:f.name,mime:f.type,data:rd.result.split(',')[1]}); rd.readAsDataURL(f);});

// ×›×•×›×‘×™×
document.querySelectorAll('.star').forEach(s=>s.onclick=()=>setStar(s.dataset.val));
function setStar(n){ currentRating=n; document.querySelectorAll('.star').forEach(s=>s.classList.toggle('filled', s.dataset.val<=n));}

// ×©××™×¨×”
async function saveRecord(){
    const rec = {
        id: 'r_'+Date.now(),
        center: E('center').value, agent: E('agent').value, date: E('date').value, time: new Date().toLocaleTimeString(),
        name: E('name').value, year: E('year').value, city: E('city').value, phone: E('phone').value, email: E('email').value,
        field: E('field').value, rating: currentRating,
        traits: [...document.querySelectorAll('.trait-chip.active')].map(c=>c.dataset.t),
        impression: E('impression').value, notes: E('notes').value
    };
    
    if(!rec.center || !rec.agent) return alert('×—×•×‘×” ×œ×‘×—×•×¨ ××•×§×“ ×•× ×¦×™×’');

    const btn = E('btnSave'); btn.textContent='×©×•×œ×—...'; btn.disabled=true;

    if(E('fileCV').files[0]) rec.fileCV = await file64(E('fileCV').files[0]);
    if(E('fileImg').files[0]) rec.fileImg = await file64(E('fileImg').files[0]);

    // ×©××™×¨×” ×œ×•×§××œ×™×ª
    const local = {...rec}; delete local.fileCV; delete local.fileImg;
    records.push(local); localStorage.setItem('recs', JSON.stringify(records));
    updCount();

    // ×©×œ×™×—×” ×œ×©×¨×ª (Hidden Form)
    const form = document.createElement('form');
    form.method='POST'; form.action=API_URL; form.target='hidden_frame';
    const inp = document.createElement('input'); 
    inp.name='data'; inp.value=JSON.stringify({action:'add', ownerId, record:rec});
    form.appendChild(inp); document.body.appendChild(form);
    
    const ifr = document.createElement('iframe'); ifr.name='hidden_frame'; ifr.style.display='none';
    document.body.appendChild(ifr); 
    form.submit();

    setTimeout(()=>{
        alert('× ×©××¨ ×‘×”×¦×œ×—×”!');
        btn.textContent='×©××•×¨ ×¨×©×•××”'; btn.disabled=false;
        clearForm(false); // × ×™×§×•×™ ×¨×’×™×œ (××©××™×¨ × ×¦×™×’)
    }, 1500);
}

// ×¤×•× ×§×¦×™×™×ª ×”× ×™×§×•×™ ×”××ª×•×§× ×ª
function clearForm(fullReset=false){
    // ×× ×‘×™×§×©× ×• ××™×¤×•×¡ ××œ× (×›×¤×ª×•×¨ ×ª×—×ª×•×Ÿ)
    if(fullReset){
        unlockHeader(); 
        E('center').value=''; 
        E('agent').innerHTML='<option value="">×‘×—×¨ × ×¦×™×’</option>';
        E('date').value='';
        // ××—×™×§×” ××”×–×™×›×¨×•×Ÿ
        localStorage.removeItem('last_agent');
        localStorage.removeItem('last_center');
        E('greeting').textContent = '×©×œ×•×, × ×¦×™×’ ğŸ‘‹';
    }

    E('name').value=''; E('phone').value=''; E('email').value=''; 
    E('city').value=''; E('year').value=''; E('field').value='';
    E('notes').value=''; E('impression').value='';
    
    // ××™×¤×•×¡ ×‘×—×™×¨×•×ª ×•×™×–×•××œ×™×•×ª
    setStar(0);
    document.querySelectorAll('.trait-chip').forEach(c=>c.classList.remove('active'));
    
    E('fileCV').value=''; updFile('fileCV','wrapCV','×§×•×—');
    E('fileImg').value=''; updFile('fileImg','wrapImg','×ª××•× ×”');
}

function updCount(){ E('totalCount').textContent = records.length; renderTable(); }
function toggleView(){ const v=E('viewTable'); const f=E('viewForm'); if(v.style.display=='none'){v.style.display='block';f.style.display='none'}else{v.style.display='none';f.style.display='block'} }

function renderTable(){
    const b=E('tableBody'); b.innerHTML='';
    records.slice().reverse().forEach(r=>{
        b.innerHTML+=`<tr><td>${r.name||'-'}</td><td>${r.field||'-'}</td><td><button onclick="del('${r.id}')">ğŸ—‘ï¸</button></td></tr>`;
    });
}

function del(id){
    if(!confirm('×œ××—×•×§?'))return;
    const r=records.find(x=>x.id==id);
    records=records.filter(x=>x.id!=id); localStorage.setItem('recs',JSON.stringify(records)); updCount();
    fetch(API_URL, {method:'POST', mode:'no-cors', body:JSON.stringify({action:'delete', ownerId, record:r})});
}

function openAdmin(){
    const c = prompt('×§×•×“ ×× ×”×œ:');
    if(c === ADMIN_CODE) window.open(SHEET_LINK, '_blank');
    else if(c) alert('×§×•×“ ×©×’×•×™');
}

init();
</script>
</body>
</html>
