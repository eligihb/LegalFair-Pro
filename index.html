<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×¨×™×©×•× ××ª×¢× ×™×™× ×™× â€“ ×™×¨×™×“ ××ª××—×™×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #0f766e;
      --primary-hover: #115e59;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #111827;
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 10px;
      font-family: 'Heebo', sans-serif;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 40px;
    }

    .shell {
      max-width: 550px;
      margin: 0 auto;
    }

    /* --- ×¡×¨×’×œ ×¡×˜×˜×™×¡×˜×™×§×” --- */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      padding: 8px 15px;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary);
    }
    .badge-count {
      background: #ecfdf5;
      color: #047857;
      padding: 2px 8px;
      border-radius: 10px;
      margin-right: 5px;
    }

    /* --- ×›×¤×ª×•×¨×™× ×¢×œ×™×•× ×™× --- */
    .top-bar {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .top-btn {
      flex: 1;
      border: 1px solid var(--border);
      background: white;
      padding: 8px;
      border-radius: 10px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #4b5563;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    .top-btn:active { transform: scale(0.98); }
    .top-btn.main {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 4px 6px -1px rgba(15, 118, 110, 0.2);
    }

    /* --- ×›×¨×˜×™×¡ ×¨××©×™ --- */
    .card {
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
      padding: 20px;
      animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      text-align: center;
      color: var(--primary);
    }
    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 15px;
    }

    /* --- ×©×“×•×ª --- */
    .section-title {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 18px 0 8px;
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--primary);
      border-bottom: 2px solid #f0fdfa;
      padding-bottom: 4px;
    }

    .grid { display: grid; gap: 10px; }
    .grid-2 { grid-template-columns: 1fr 1fr; }

    label {
      display: block;
      font-size: 0.82rem;
      font-weight: 600;
      color: #374151;
      margin-bottom: 4px;
    }
    .req::after { content: " *"; color: #ef4444; }

    input, select, textarea {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 10px;
      font-size: 0.95rem;
      background: #f9fafb;
      transition: 0.2s;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      background: white;
      box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.15);
    }
    textarea { resize: vertical; min-height: 80px; }

    /* --- ×›×¤×ª×•×¨×™ ×”×¢×œ××ª ×§×‘×¦×™× ××¢×•×¦×‘×™× --- */
    .file-upload-wrapper {
      position: relative;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      background: #f8fafc;
      text-align: center;
      padding: 15px 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .file-upload-wrapper:hover {
      border-color: var(--primary);
      background: #f0fdfa;
    }
    .file-upload-wrapper.has-file {
      border-style: solid;
      border-color: #10b981;
      background: #ecfdf5;
    }
    .file-upload-input {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    .file-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
    .file-label-text { font-size: 0.8rem; color: #64748b; font-weight: 500; }

    /* --- ×›×•×›×‘×™× ×•×¦'×™×¤×™× --- */
    .stars { display: inline-flex; gap: 5px; direction: ltr; }
    .star { font-size: 1.6rem; cursor: pointer; color: #e5e7eb; transition: 0.2s; }
    .star.filled { color: #f59e0b; transform: scale(1.1); }

    .traits { display: flex; flex-wrap: wrap; gap: 6px; }
    .trait-chip {
      border-radius: 20px;
      border: 1px solid var(--border);
      padding: 5px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      background: white;
      transition: 0.2s;
    }
    .trait-chip.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 2px 5px rgba(15, 118, 110, 0.3);
    }

    /* --- ×›×¤×ª×•×¨×™× ×¨××©×™×™× --- */
    .btn-main {
      width: 100%;
      border: none;
      border-radius: 999px;
      padding: 12px;
      font-size: 1rem;
      font-weight: 700;
      background: var(--primary);
      color: white;
      cursor: pointer;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(15, 118, 110, 0.3);
      transition: 0.2s;
    }
    .btn-main:hover { background: var(--primary-hover); transform: translateY(-1px); }
    .btn-main:disabled { background: #9ca3af; cursor: not-allowed; }

    .btn-sub {
      width: 100%;
      margin-top: 10px;
      border-radius: 999px;
      padding: 8px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid transparent;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
    }
    .btn-sub:hover { background: #f3f4f6; }

    /* --- ×”×•×“×¢×•×ª --- */
    .msg { margin-top: 10px; font-size: 0.85rem; padding: 10px; border-radius: 8px; display: none; text-align: center; }
    .msg-ok { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
    .msg-err { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }

    /* === ××¡×š ×˜×‘×œ×” (××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ) === */
    #viewTable { display: none; }
    
    .table-container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      padding: 15px;
      overflow-x: auto;
    }
    
    .styled-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      min-width: 600px; /* ×’×œ×™×œ×” ×œ×¨×•×—×‘ ×‘××•×‘×™×™×œ */
    }
    .styled-table thead tr {
      background-color: var(--primary);
      color: #ffffff;
      text-align: right;
    }
    .styled-table th, .styled-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #dddddd;
    }
    .styled-table tbody tr:nth-of-type(even) { background-color: #f3f3f3; }
    .styled-table tbody tr:hover { background-color: #f0fdfa; }

    .actions-cell { display: flex; gap: 5px; }
    .btn-small {
      border: none; padding: 4px 8px; border-radius: 6px; cursor: pointer; font-size: 0.75rem;
    }
    .btn-edit { background: #dbeafe; color: #1e40af; }
    .btn-del { background: #fee2e2; color: #991b1b; }

  </style>
</head>
<body>
<div class="shell">

  <div class="stats-bar">
    <div id="greeting">×©×œ×•×, × ×¦×™×’ ğŸ‘‹</div>
    <div>×¡×”"×› ×¨×©×•××•×ª: <span id="totalCount" class="badge-count">0</span></div>
  </div>

  <div class="top-bar">
    <button id="btnToggleView" class="top-btn" onclick="toggleView()">
      ğŸ“„ ×”×¦×’ ×¨×©×•××•×ª
    </button>
    <button id="btnExportAdmin" class="top-btn main">
      ğŸ“Š × ×™×”×•×œ ×’×™×œ×™×•×Ÿ
    </button>
  </div>

  <div id="viewForm">
    <div class="card">
      <h1>×¨×™×©×•× ××ª×¢× ×™×™× ×™×</h1>
      <div class="subtitle">×™×¨×™×“ ××ª××—×™× 2025</div>

      <div class="section-title">ğŸ“ ×¤×¨×˜×™ ××•×§×“ ×•× ×¦×™×’</div>
      <div class="grid grid-2">
        <div>
          <label class="req">××•×§×“</label>
          <select id="center">
            <option value="">×‘×—×¨ ××•×§×“</option>
            <option>××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ</option>
            <option>(×¡×™××•×œ×¦×™×™×ª ×©×•×ª×¤×™× ×œ×“×¨×š)</option>
            <option>××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ</option>
            <option>××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ-××‘×™×‘</option>
            <option>××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜</option>
            <option>×©×•×ª×¤×™× ×œ×“×¨×š</option>
            <option>××›×œ×œ×ª ×¡×¤×™×¨</option>
            <option>×”××›×œ×œ×” ×œ×× ×”×œ ×¨××©×œ"×¦</option>
            <option>×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª</option>
          </select>
        </div>
        <div>
          <label class="req">×©× × ×¦×™×’</label>
          <select id="agent">
            <option value="">×‘×—×¨ × ×¦×™×’</option>
          </select>
        </div>
      </div>
      <div class="grid" style="margin-top:6px;">
         <div style="width:100%;"><label>×ª××¨×™×š</label><input id="date" type="date"></div>
      </div>

      <div class="section-title">ğŸ“ ×¤×¨×˜×™ ×¡×˜×•×“× ×˜</div>
      <div class="grid">
        <div>
          <label>×©× ××œ×</label>
          <input id="name" type="text" placeholder="×œ×“×•×’××”: ×™×©×¨××œ ×™×©×¨××œ×™">
        </div>
        <div class="grid grid-2">
          <div>
            <label>×©× ×”</label>
            <select id="year">
              <option value="">×‘×—×¨...</option>
              <option>×©× ×” ×'</option>
              <option>×©× ×” ×‘'</option>
              <option>×©× ×” ×’'</option>
              <option>×©× ×” ×“'</option>
              <option>×¡×˜××–'</option>
            </select>
          </div>
          <div>
            <label>×¢×™×¨</label>
            <input id="city" type="text" placeholder="×¢×™×¨ ××’×•×¨×™×">
          </div>
        </div>
        <div class="grid grid-2">
          <div>
            <label>×˜×œ×¤×•×Ÿ</label>
            <input id="phone" type="tel" placeholder="050-0000000">
          </div>
          <div>
            <label>××™×™×œ</label>
            <input id="email" type="email" placeholder="email@example.com">
          </div>
        </div>
        <div>
          <label>×ª×—×•× ××•×¢×“×£</label>
          <select id="field">
            <option value="">×‘×—×¨ ×ª×—×•×...</option>
            <option>×œ×™×˜×™×’×¦×™×”</option>
            <option>××¡×—×¨×™</option>
            <option>×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</option>
            <option>×“×™× ×™ ×¢×‘×•×“×”</option>
            <option>× ×–×™×§×™×Ÿ</option>
            <option>××©×¤×—×”</option>
            <option>×¤×œ×™×œ×™</option>
          </select>
        </div>

        <div class="grid grid-2" style="margin-top:5px;">
           <div class="file-upload-wrapper" id="wrapCV">
              <input type="file" id="fileCV" class="file-upload-input" accept=".pdf,.doc,.docx" onchange="updateFileLabel('fileCV','lblCV','wrapCV')">
              <span class="file-icon">ğŸ“„</span>
              <div class="file-label-text" id="lblCV">×”×¢×œ××ª ×§×•"×—</div>
           </div>
           
           <div class="file-upload-wrapper" id="wrapImg">
              <input type="file" id="fileImg" class="file-upload-input" accept="image/*" onchange="updateFileLabel('fileImg','lblImg','wrapImg')">
              <span class="file-icon">ğŸ“·</span>
              <div class="file-label-text" id="lblImg">×”×¢×œ××ª ×ª××•× ×”</div>
           </div>
        </div>
      </div>

      <div class="section-title">â­ ×”×ª×¨×©××•×ª ×•×¡×™×›×•×</div>
      <div class="grid">
        <div>
          <label>×“×™×¨×•×’ ×›×œ×œ×™</label>
          <div id="stars" class="stars">
            <span class="star" data-val="1">â˜…</span>
            <span class="star" data-val="2">â˜…</span>
            <span class="star" data-val="3">â˜…</span>
            <span class="star" data-val="4">â˜…</span>
            <span class="star" data-val="5">â˜…</span>
          </div>
        </div>

        <div>
          <label>×ª×›×•× ×•×ª ×‘×•×œ×˜×•×ª</label>
          <div id="traitsBox" class="traits">
            <span class="trait-chip" data-t="×—×¨×™×¦×•×ª">×—×¨×™×¦×•×ª</span>
            <span class="trait-chip" data-t="××§×¦×•×¢×™×•×ª">××§×¦×•×¢×™×•×ª</span>
            <span class="trait-chip" data-t="× ×™×¡×™×•×Ÿ">× ×™×¡×™×•×Ÿ</span>
            <span class="trait-chip" data-t="×©×¤×” ×¢×©×™×¨×”">×©×¤×” ×¢×©×™×¨×”</span>
            <span class="trait-chip" data-t="×›×¨×™×–××˜×™">×›×¨×™×–××˜×™</span>
            <span class="trait-chip" data-t="×•×¨×‘×œ×™">×•×¨×‘×œ×™</span>
            <span class="trait-chip" data-t="×‘×™×™×©×Ÿ">×‘×™×™×©×Ÿ</span>
          </div>
        </div>

        <div>
          <label>ğŸ“ ×”×ª×¨×©××•×ª ××™×œ×•×œ×™×ª</label>
          <textarea id="impression" placeholder="××” ×—×©×‘×ª ×¢×œ ×”××•×¢××“?"></textarea>
        </div>

        <div>
          <label>ğŸ”’ ×”×¢×¨×•×ª ×¤× ×™××™×•×ª (×—×¡×•×™)</label>
          <textarea id="notes" placeholder="×ª×–×›×•×¨×•×ª ×œ×”××©×š ×˜×™×¤×•×œ..."></textarea>
        </div>
      </div>

      <button id="btnSave" class="btn-main">ğŸ’¾ ×©××•×¨ ×¨×©×•××”</button>
      <button id="btnClear" class="btn-sub">× ×™×§×•×™ ×˜×•×¤×¡</button>

      <div id="msgOk" class="msg msg-ok"></div>
      <div id="msgErr" class="msg msg-err"></div>

    </div>
  </div> <div id="viewTable">
    <div class="table-container">
       <h2 style="margin-top:0;color:var(--primary);text-align:center;">×”×™×¡×˜×•×¨×™×™×ª ×¨×©×•××•×ª</h2>
       <div style="overflow-x:auto;">
         <table class="styled-table">
            <thead>
               <tr>
                 <th>×©×</th>
                 <th>×˜×œ×¤×•×Ÿ</th>
                 <th>×ª×—×•×</th>
                 <th>×ª××¨×™×š</th>
                 <th>×¤×¢×•×œ×•×ª</th>
               </tr>
            </thead>
            <tbody id="tableBody">
               </tbody>
         </table>
       </div>
       <button class="btn-main" onclick="toggleView()" style="margin-top:15px;background:#64748b;">ğŸ”™ ×—×–×•×¨ ×œ×˜×•×¤×¡</button>
    </div>
  </div>

</div>

<script>
  // ===== ×”×’×“×¨×•×ª =====
  const API_URL    = 'https://script.google.com/macros/s/AKfycbwip8xRO6q99yg_iX5KRddVmv3suZmeCEQJ4_TGY4MVtENw3WcrDHUEnTUBI3D7KdE/exec';
  const ADMIN_CODE = '2100';
  const SHEET_URL  = 'https://docs.google.com/spreadsheets/d/1Oz32yNCobHdhz0APS4zl5O34rkqZxGvP0TJgPKKDLdk/edit?pli=1&gid=487137334#gid=487137334';
  
  const STORAGE_KEY = 'lfp_records_v4';
  const OWNER_KEY   = 'lfp_owner_id_v1';

  let records = [];
  let ownerId = null;
  let editingId = null;
  let currentRating = 0;
  let isTableView = false;

  const E = id => document.getElementById(id);

  // ===== ×œ×•×— ×–×× ×™× =====
  const FAIR_SCHEDULE = [
    { centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ",            date:"2025-12-01", agents:["×™×¢×§×‘","××•×¤×™×¨","×©×§×“","×’×œ"] },
    { centerName:"(×¡×™××•×œ×¦×™×™×ª ×©×•×ª×¤×™× ×œ×“×¨×š)",     date:"2025-12-02", agents:["××•×¨×™","××™×ª×™ ×©×’×‘","×¦×™×•× ×”"] },
    { centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ",          date:"2025-12-03", agents:["××™×œ×•×Ÿ","×™×¢×§×‘","××œ×™××‘","×‘×™×¡××Ÿ"] },
    { centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ-××‘×™×‘",          date:"2025-12-04", agents:["××•×¨×™","××•×¤×™×¨","×¦×œ×™×œ"] },
    { centerName:"××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜",         date:"2025-12-08", agents:["××•×¨×™","××•×¤×™×¨","×¦×œ×™×œ"] },
    { centerName:"×©×•×ª×¤×™× ×œ×“×¨×š",                 date:"2025-12-08", agents:["××™×ª×™*","×¦×™×•× ×”*"] },
    { centerName:"××›×œ×œ×ª ×¡×¤×™×¨",                   date:"2025-12-09", agents:["×‘×§×™","××™×ª×™"] },
    { centerName:"×”××›×œ×œ×” ×œ×× ×”×œ ×¨××©×œ\"×¦",         date:"2025-12-25", agents:["××•×¨×™","×¦×™×•× ×”","××•×¤×™×¨"] },
    { centerName:"×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª",          date:"2025-12-28", agents:["××•×¨×™","××œ×™××‘"] }
  ];

  function initOwner(){
    ownerId = localStorage.getItem(OWNER_KEY);
    if(!ownerId){
      ownerId = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
      localStorage.setItem(OWNER_KEY, ownerId);
    }
  }

  // ===== UI ×¢×“×›×•× ×™× =====
  
  // ×”×—×œ×¤×ª ××¡×›×™× (×˜×•×¤×¡ <-> ×˜×‘×œ×”)
  function toggleView() {
      isTableView = !isTableView;
      const formDiv = E('viewForm');
      const tableDiv = E('viewTable');
      const btn = E('btnToggleView');
      
      if(isTableView) {
          formDiv.style.display = 'none';
          tableDiv.style.display = 'block';
          btn.innerHTML = 'âœï¸ ×—×–×•×¨ ×œ×˜×•×¤×¡';
          renderTable(); // ×¨×¢× ×•×Ÿ ×”×˜×‘×œ×”
      } else {
          formDiv.style.display = 'block';
          tableDiv.style.display = 'none';
          btn.innerHTML = 'ğŸ“„ ×”×¦×’ ×¨×©×•××•×ª';
      }
  }
  
  // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨×™ ×”×¢×œ××”
  function updateFileLabel(inputId, labelId, wrapperId) {
      const input = E(inputId);
      const label = E(labelId);
      const wrap = E(wrapperId);
      
      if(input.files && input.files.length > 0) {
          const name = input.files[0].name;
          label.textContent = (name.length > 15) ? name.substring(0,12)+'...' : name;
          label.style.color = '#065f46';
          label.style.fontWeight = 'bold';
          wrap.classList.add('has-file');
      } else {
          label.textContent = (inputId === 'fileCV') ? '×”×¢×œ××ª ×§×•"×—' : '×”×¢×œ××ª ×ª××•× ×”';
          label.style.color = '#64748b';
          label.style.fontWeight = '500';
          wrap.classList.remove('has-file');
      }
  }

  // ×˜×œ×¤×•×Ÿ
  E('phone').addEventListener('input', () => {
    E('phone').value = E('phone').value.replace(/\D/g,'').slice(0,10);
  });

  // ×›×•×›×‘×™×
  function updateStars(v){
    currentRating = v;
    document.querySelectorAll('#stars .star').forEach(s=>{
      const val = Number(s.dataset.val);
      s.classList.toggle('filled', val<=v);
    });
  }
  document.querySelectorAll('#stars .star').forEach(s=>{
    s.addEventListener('click',()=>updateStars(Number(s.dataset.val)));
  });

  // ×¦'×™×¤×™×
  document.querySelectorAll('.trait-chip').forEach(ch=>{
    ch.addEventListener('click',()=>ch.classList.toggle('active'));
  });
  
  // ×‘×—×™×¨×ª ××•×§×“
  function onCenterChange(){
    const val = E('center').value;
    const slot = FAIR_SCHEDULE.find(s=>s.centerName===val);
    if(slot){
      E('date').value = slot.date;
      const agentSel = E('agent');
      agentSel.innerHTML = '<option value="">×‘×—×¨ × ×¦×™×’</option>';
      slot.agents.forEach(a=>{
        const clean = a.replace('*','').trim();
        const opt = document.createElement('option');
        opt.value = clean;
        opt.textContent = clean;
        agentSel.appendChild(opt);
      });
    }else{
      E('date').value = '';
      E('agent').innerHTML = '<option value="">×‘×—×¨ × ×¦×™×’</option>';
    }
  }
  E('center').addEventListener('change', onCenterChange);

  // ×•×œ×™×“×¦×™×”
  function clearErrors(){
    ['center','agent','phone','email'].forEach(id=>E(id).classList.remove('error'));
    E('msgErr').style.display='none';
    E('msgOk').style.display='none';
  }
  function isValidPhone(p){
    const d = (p||'').replace(/\D/g,'');
    return !d || d.length===9 || d.length===10;
  }
  function isValidEmail(e){
    if(!e) return true;
    const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(e);
  }

  // ×”××¨×ª ×§×‘×¦×™×
  const fileToBase64 = file => new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve({
      name: file.name,
      mime: file.type,
      data: reader.result.split(',')[1]
    });
    reader.onerror = error => reject(error);
  });

  // ===== ×©××™×¨×” / ×¢×“×›×•×Ÿ =====
  async function saveRecord(){
    clearErrors();

    // ×‘×“×™×§×ª ×’×•×“×œ ×§×‘×¦×™×
    const MAX_SIZE = 4 * 1024 * 1024; // 4MB
    const cvInput = E('fileCV').files[0];
    const imgInput = E('fileImg').files[0];

    if(cvInput && cvInput.size > MAX_SIZE) { alert('×§×•×‘×¥ ×§×•"×— ×’×“×•×œ ××“×™'); return; }
    if(imgInput && imgInput.size > MAX_SIZE) { alert('×§×•×‘×¥ ×ª××•× ×” ×’×“×•×œ ××“×™'); return; }

    const center = E('center').value.trim();
    const agent  = E('agent').value.trim();
    const date   = E('date').value;
    const name   = E('name').value.trim();
    const year   = E('year').value;
    const city   = E('city').value.trim();
    const phone  = E('phone').value.trim();
    const email  = E('email').value.trim();
    const field  = E('field').value;
    const impression = E('impression').value.trim();
    const notes      = E('notes').value.trim();
    const traits = Array.from(document.querySelectorAll('.trait-chip.active')).map(ch=>ch.dataset.t);

    const errors = [];
    if(!center){errors.push('×—×¡×¨ ××•×§×“.');E('center').classList.add('error');}
    if(!agent){errors.push('×—×¡×¨ × ×¦×™×’.');E('agent').classList.add('error');}
    if(!isValidPhone(phone)){errors.push('×˜×œ×¤×•×Ÿ ×œ× ×ª×§×™×Ÿ.');E('phone').classList.add('error');}
    if(!isValidEmail(email)){errors.push('××™×™×œ ×œ× ×ª×§×™×Ÿ.');E('email').classList.add('error');}

    if(errors.length){
      E('msgErr').textContent = errors.join(', ');
      E('msgErr').style.display='block';
      return;
    }

    // UI ×”××ª× ×”
    const btn = E('btnSave');
    const orgBtnText = btn.textContent;
    btn.textContent = 'â³ ×©×•××¨...';
    btn.disabled = true;

    // ×”××¨×ª ×§×‘×¦×™×
    let fileCVData = null;
    let fileImgData = null;
    try {
        if(cvInput) fileCVData = await fileToBase64(cvInput);
        if(imgInput) fileImgData = await fileToBase64(imgInput);
    } catch(e) {
        alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×‘×¦×™×');
        btn.textContent = orgBtnText;
        btn.disabled = false;
        return;
    }

    const id = editingId || ('r_'+Date.now()+'_'+Math.random().toString(36).slice(2,7));
    const now = new Date();
    const time = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});

    const rec = {
      id, ownerId,
      center, agent, date, time,
      name, year, city, phone, email, field,
      rating:currentRating, traits, impression, notes,
      fileCV: fileCVData,
      fileImg: fileImgData
    };

    // ×©××™×¨×” ××§×•××™×ª
    const localRec = {...rec};
    delete localRec.fileCV; delete localRec.fileImg;

    const idx = records.findIndex(r=>r.id===id);
    if(idx>=0) records[idx]=localRec;
    else records.push(localRec);
    persistRecords();
    updateTotalCount(); // ×¢×“×›×•×Ÿ ×”××•× ×”

    // ×©×œ×™×—×” ×œ×©×¨×ª
    try{
      if(API_URL && API_URL.includes('script.google.com')){
        await fetch(API_URL,{
          method:'POST',
          mode: 'no-cors',
          body:JSON.stringify({action:'add', ownerId, record:rec})
        });
      }
      E('msgOk').textContent = '× ×©××¨ ×‘×”×¦×œ×—×”!';
      E('msgOk').style.display='block';
      setTimeout(()=>alert('×”× ×ª×•× ×™× ×•×”×§×‘×¦×™× × ×©××¨×• ×‘×”×¦×œ×—×”!'), 100);

    } catch(err){
      console.error('sync error:', err);
      E('msgErr').textContent = '× ×©××¨ ××§×•××™×ª, ×‘×¢×™×™×ª ×¨×©×ª.';
      E('msgErr').style.display='block';
    }

    btn.textContent = orgBtnText;
    btn.disabled = false;
    clearForm(false);
    E('fileCV').value = ''; E('fileImg').value = '';
    updateFileLabel('fileCV','lblCV','wrapCV');
    updateFileLabel('fileImg','lblImg','wrapImg');
  }

  function clearForm(resetHeader=true){
    if(resetHeader){
      E('center').value='';
      E('agent').innerHTML='<option value="">×‘×—×¨ × ×¦×™×’</option>';
      E('date').value='';
    }
    ['name','year','city','phone','email','field','impression','notes'].forEach(id=>E(id).value='');
    document.querySelectorAll('.trait-chip').forEach(ch=>ch.classList.remove('active'));
    updateStars(0);
    editingId=null;
    clearErrors();
    
    // × ×™×§×•×™ ×§×‘×¦×™×
    E('fileCV').value = ''; E('fileImg').value = '';
    updateFileLabel('fileCV','lblCV','wrapCV');
    updateFileLabel('fileImg','lblImg','wrapImg');
  }

  // ===== × ×ª×•× ×™× =====
  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      records = raw ? JSON.parse(raw) : [];
    }catch{
      records=[];
    }
    updateTotalCount();
  }
  function persistRecords(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }
  function updateTotalCount() {
      const mine = records.filter(r=>r.ownerId===ownerId);
      E('totalCount').textContent = mine.length;
  }

  // ×‘× ×™×™×ª ×”×˜×‘×œ×”
  function renderTable(){
    const tbody = E('tableBody');
    tbody.innerHTML = '';
    const mine = records.filter(r=>r.ownerId===ownerId);
    
    if(mine.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</td></tr>';
        return;
    }

    // ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×™×•×¨×“
    mine.sort((a,b) => b.id.localeCompare(a.id));

    mine.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
           <td><strong>${r.name || '-'}</strong></td>
           <td>${r.phone || '-'}</td>
           <td>${r.field || '-'}</td>
           <td>${r.date || '-'}</td>
           <td>
              <div class="actions-cell">
                 <button class="btn-small btn-edit" onclick="editFromTable('${r.id}')">âœï¸</button>
                 <button class="btn-small btn-del" onclick="deleteRecord('${r.id}')">ğŸ—‘ï¸</button>
              </div>
           </td>
        `;
        tbody.appendChild(tr);
    });
  }

  function editFromTable(id) {
      toggleView(); // ×—×–×¨×” ×œ×˜×•×¤×¡
      startEdit(id);
  }

  function startEdit(id){
    const r = records.find(x=>x.id===id);
    if(!r) return;
    editingId = id;

    E('center').value=r.center||'';
    onCenterChange();
    E('agent').value=r.agent||'';
    E('date').value=r.date||'';

    E('name').value=r.name||'';
    E('year').value=r.year||'';
    E('city').value=r.city||'';
    E('phone').value=r.phone||'';
    E('email').value=r.email||'';
    E('field').value=r.field||'';
    E('impression').value=r.impression||'';
    E('notes').value=r.notes||'';

    document.querySelectorAll('.trait-chip').forEach(ch=>{
      const t = ch.dataset.t;
      ch.classList.toggle('active', (r.traits||[]).includes(t));
    });
    updateStars(r.rating||0);
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function deleteRecord(id){
    const r = records.find(x=>x.id===id);
    if(!r) return;
    if(!confirm('×œ××—×•×§ ×¨×©×•××” ×–×•?')) return;

    records = records.filter(x=>x.id!==id);
    persistRecords();
    updateTotalCount();
    
    if(isTableView) renderTable();

    try{
      if(API_URL && API_URL.includes('script.google.com')){
        await fetch(API_URL,{
          method:'POST',
          mode: 'no-cors',
          body:JSON.stringify({action:'delete',ownerId,record:r})
        });
      }
    }catch(err){}
  }

  // ===== ×›×¤×ª×•×¨×™× =====
  E('btnTopClear').addEventListener('click',()=>clearForm(true));

  E('btnExportAdmin').addEventListener('click',()=>{
    const code = prompt('×§×•×“ ×× ×”×œ:');
    if(code===ADMIN_CODE){
      window.open(SHEET_URL,'_blank');
    }else if(code){
      alert('×§×•×“ ×©×’×•×™');
    }
  });

  E('btnClear').addEventListener('click',()=>clearForm(true));
  E('btnSave').addEventListener('click',saveRecord);

  // ===== ××ª×—×•×œ =====
  (function init(){
    initOwner();
    loadRecords();
  })();
</script>
</body>
</html>
