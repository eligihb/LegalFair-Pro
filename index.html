<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>×¨×™×©×•× ××ª×¢× ×™×™× ×™× â€“ ×™×¨×™×“ ××ª××—×™×</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;}

    body{
      margin:0;
      padding:10px;
      font-family:'Heebo',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      background:#f3f4f6;
      color:#111827;
    }

    .shell{
      max-width:480px;
      margin:0 auto;
    }

    .top-bar{
      display:flex;
      gap:6px;
      margin-bottom:8px;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .top-btn{
      flex:1 1 0;
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:6px 10px;
      font-size:.8rem;
      font-weight:600;
      background:#ffffff;
      cursor:pointer;
      text-align:center;
      white-space:nowrap;
    }
    .top-btn.main{
      background:#0f766e;
      color:#fff;
      border-color:#0f766e;
    }

    .card{
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 6px 18px rgba(15,23,42,.12);
      padding:14px 12px 16px;
    }

    h1{
      margin:0 0 4px;
      font-size:1.35rem;
      text-align:center;
      color:#0f766e;
    }

    .subtitle{
      text-align:center;
      font-size:.85rem;
      color:#6b7280;
      margin-bottom:8px;
    }

    .section-title{
      margin:10px 0 4px;
      font-size:.9rem;
      font-weight:700;
      color:#0f766e;
      border-bottom:1px solid #e5e7eb;
      padding-bottom:3px;
    }

    .grid{display:grid;gap:6px;}
    .grid-2{grid-template-columns: minmax(0,1.05fr) minmax(0,.95fr);}
    @media(max-width:600px){.grid-2{grid-template-columns:1fr;}}

    label{
      display:block;
      font-size:.82rem;
      font-weight:600;
      color:#374151;
      margin-bottom:2px;
    }
    .req::after{
      content:" *";
      color:#b91c1c;
      font-weight:700;
    }

    input,select,textarea{
      width:100%;
      border-radius:10px;
      border:1px solid #d1d5db;
      padding:7px 8px;
      font-size:.9rem;
      background:#f9fafb;
      transition:border-color .15s,box-shadow .15s,background .15s;
    }
    input:focus,select:focus,textarea:focus{
      outline:none;
      border-color:#0f766e;
      box-shadow:0 0 0 2px rgba(16,185,129,.25);
      background:#fff;
    }
    textarea{resize:vertical;min-height:70px;}

    .short{max-width:220px;}
    .short-inline{max-width:200px;}

    .hint{
      font-size:.75rem;
      color:#9ca3af;
      margin-top:1px;
    }

    .error{
      border-color:#dc2626!important;
      box-shadow:0 0 0 1px rgba(220,38,38,.4)!important;
      background:#fef2f2!important;
    }

    .btn-main{
      width:100%;
      border:none;
      border-radius:999px;
      padding:10px;
      font-size:.96rem;
      font-weight:700;
      background:#0f766e;
      color:#fff;
      cursor:pointer;
      margin-top:10px;
    }
    .btn-main:hover{background:#115e59;}

    .btn-sub{
      width:100%;
      margin-top:5px;
      border-radius:999px;
      padding:7px;
      font-size:.8rem;
      font-weight:600;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      cursor:pointer;
    }

    .msg{
      margin-top:6px;
      font-size:.8rem;
      padding:5px 7px;
      border-radius:9px;
      display:none;
    }
    .msg-ok{
      background:#ecfdf3;
      border:1px solid #bbf7d0;
      color:#166534;
    }
    .msg-err{
      background:#fef2f2;
      border:1px solid #fecaca;
      color:#b91c1c;
    }

    /* ×›×•×›×‘×™× */
    .stars{
      display:inline-flex;
      gap:3px;
      direction:ltr;
    }
    .star{
      font-size:1.3rem;
      cursor:pointer;
      color:#e5e7eb;
      transition:color .15s,transform .1s;
    }
    .star.filled{color:#f59e0b;}
    .star:hover{transform:scale(1.1);}

    /* ×¦'×™×¤×™× */
    .traits{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      margin-top:3px;
    }
    .trait-chip{
      border-radius:999px;
      border:1px solid #d1d5db;
      padding:3px 8px;
      font-size:.78rem;
      cursor:pointer;
      background:#f9fafb;
      color:#374151;
    }
    .trait-chip.active{
      background:#0f766e;
      color:#fff;
      border-color:#0f766e;
    }

    /* ×¨×©×•××•×ª */
    .records-wrap{
      margin-top:10px;
    }
    .records-title{
      font-size:.9rem;
      font-weight:700;
      color:#111827;
      margin-bottom:4px;
    }
    .record-card{
      background:#eef2ff;
      border:1px solid #c7d2fe;
      border-radius:12px;
      padding:8px 9px;
      margin-bottom:6px;
      font-size:.8rem;
      position:relative;
    }
    .record-header{
      display:flex;
      justify-content:space-between;
      gap:6px;
      margin-bottom:4px;
    }
    .record-meta{color:#4b5563;font-size:.76rem;}
    .record-actions{
      display:flex;
      gap:4px;
    }
    .icon-btn{
      border:none;
      background:#fff;
      border-radius:999px;
      padding:1px 7px;
      font-size:.7rem;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:3px;
    }
    .icon-btn.del{color:#b91c1c;}
    .icon-btn.edit{color:#065f46;}
  </style>
</head>
<body>
<div class="shell">

  <!-- ×›×¤×ª×•×¨×™× ×¢×œ×™×•× ×™× -->
  <div class="top-bar">
    <button id="btnOpenRecords" class="top-btn">×¤×ª×— ×¨×©×•××•×ª</button>
    <button id="btnTopClear" class="top-btn">××™×¤×•×¡ ×˜×•×¤×¡</button>
    <button id="btnExportAdmin" class="top-btn main">×™×™×¦×•× / ×¤×ª×™×—×ª ×’×™×œ×™×•×Ÿ (×œ××•×¨×©×™×)</button>
  </div>

  <div class="card">
    <h1>×¨×™×©×•× ××ª×¢× ×™×™× ×™×</h1>
    <div class="subtitle">×—×•×‘×¨×ª ×¢×‘×•×“×” ××§×•×•× ×ª ×œ×™×¨×™×“ ××ª××—×™×</div>

    <!-- ×¤×¨×˜×™ ××•×§×“ ×•× ×¦×™×’ -->
    <div class="section-title">×¤×¨×˜×™ ××•×§×“ ×•× ×¦×™×’</div>
    <div class="grid grid-2">
      <div>
        <label class="req">××•×§×“</label>
        <select id="center" class="short">
          <option value="">×‘×—×¨ ××•×§×“</option>
          <option>××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ</option>
          <option>(×¡×™××•×œ×¦×™×™×ª ×©×•×ª×¤×™× ×œ×“×¨×š)</option>
          <option>××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ</option>
          <option>××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ-××‘×™×‘</option>
          <option>××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜</option>
          <option>×©×•×ª×¤×™× ×œ×“×¨×š</option>
          <option>××›×œ×œ×ª ×¡×¤×™×¨</option>
          <option>×”××›×œ×œ×” ×œ×× ×”×œ ×¨××©×œ"×¦</option>
          <option>×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª</option>
        </select>
      </div>
      <div>
        <label class="req">×©× × ×¦×™×’</label>
        <select id="agent" class="short-inline">
          <option value="">×‘×—×¨ × ×¦×™×’</option>
        </select>
      </div>
    </div>

    <div class="grid" style="margin-top:6px;">
      <div style="max-width:190px;">
        <label>×ª××¨×™×š ×™×¨×™×“</label>
        <input id="date" type="date">
      </div>
    </div>

    <!-- ×¤×¨×˜×™ ×¡×˜×•×“× ×˜ -->
    <div class="section-title">×¤×¨×˜×™ ×¡×˜×•×“× ×˜</div>
    <div class="grid">
      <div>
        <label>×©× ×¡×˜×•×“× ×˜</label>
        <input id="name" type="text" placeholder="×œ×“×•×’××”: ×“× ×” ×›×”×Ÿ">
      </div>

      <div class="grid grid-2">
        <div>
          <label>×©× ×”</label>
          <select id="year">
            <option value="">×‘×—×¨ ×©× ×”</option>
            <option>×©× ×” ×'</option>
            <option>×©× ×” ×‘'</option>
            <option>×©× ×” ×’'</option>
            <option>×©× ×” ×“'</option>
            <option>×¡×˜××–'</option>
          </select>
        </div>
        <div>
          <label>×¢×™×¨</label>
          <input id="city" type="text" placeholder="×œ×“×•×’××”: × ×ª× ×™×”">
        </div>
      </div>

      <div class="grid grid-2">
        <div>
          <label>×˜×œ×¤×•×Ÿ</label>
          <input id="phone" type="tel" inputmode="tel" placeholder="050-0000000">
          <div class="hint">9â€“10 ×¡×¤×¨×•×ª, × ×™×ª×Ÿ ×¢× ××§×¤×™×</div>
        </div>
        <div>
          <label>××™×™×œ</label>
          <input id="email" type="email" class="short" placeholder="example@mail.com">
        </div>
      </div>

      <div>
        <label>×ª×—×•× ××•×¢×“×£</label>
        <select id="field">
          <option value="">×‘×—×¨ ×ª×—×•×</option>
          <option>×œ×™×˜×™×’×¦×™×”</option>
          <option>××¡×—×¨×™</option>
          <option>×—×“×œ×•×ª ×¤×™×¨×¢×•×Ÿ</option>
          <option>×“×™× ×™ ×¢×‘×•×“×”</option>
          <option>× ×–×™×§×™×Ÿ</option>
          <option>××©×¤×—×”</option>
          <option>×¤×œ×™×œ×™</option>
        </select>
      </div>
    </div>

    <!-- ×”×ª×¨×©××•×ª -->
    <div class="section-title">×”×ª×¨×©××•×ª ××”×¡×˜×•×“× ×˜</div>
    <div class="grid">
      <div>
        <label>×“×™×¨×•×’ (×›×•×›×‘×™×)</label>
        <div id="stars" class="stars">
          <span class="star" data-val="1">â˜…</span>
          <span class="star" data-val="2">â˜…</span>
          <span class="star" data-val="3">â˜…</span>
          <span class="star" data-val="4">â˜…</span>
          <span class="star" data-val="5">â˜…</span>
        </div>
      </div>

      <div>
        <label>×××¤×™×™× ×™× ×‘×•×œ×˜×™×</label>
        <div id="traitsBox" class="traits">
          <span class="trait-chip" data-t="×—×¨×™×¦×•×ª">×—×¨×™×¦×•×ª</span>
          <span class="trait-chip" data-t="××§×¦×•×¢×™×•×ª">××§×¦×•×¢×™×•×ª</span>
          <span class="trait-chip" data-t="× ×™×¡×™×•×Ÿ">× ×™×¡×™×•×Ÿ</span>
          <span class="trait-chip" data-t="×©×¤×” ×¢×©×™×¨×”">×©×¤×” ×¢×©×™×¨×”</span>
          <span class="trait-chip" data-t="×›×¨×™×–××˜×™">×›×¨×™×–××˜×™</span>
          <span class="trait-chip" data-t="×•×¨×‘×œ×™">×•×¨×‘×œ×™</span>
          <span class="trait-chip" data-t="×‘×™×™×©×Ÿ">×‘×™×™×©×Ÿ</span>
        </div>
      </div>

      <div>
        <label>×”×ª×¨×©××•×ª ×›×œ×œ×™×ª</label>
        <textarea id="impression" placeholder="×¨×•×©×, ×”×ª×××”, ×—×•×•"×“..."></textarea>
      </div>

      <div>
        <label>×”×¢×¨×•×ª ×¤× ×™××™×•×ª</label>
        <textarea id="notes" placeholder="×¤×¨×˜×™ ×”××©×š ×˜×™×¤×•×œ, ×ª×–×›×•×¨×•×ª ×•×¢×•×“..."></textarea>
      </div>
    </div>

    <button id="btnSave" class="btn-main">×”×•×¡×£ ×¨×©×•××”</button>
    <button id="btnClear" class="btn-sub">× ×§×” ×˜×•×¤×¡</button>

    <div id="msgOk" class="msg msg-ok">×”×¨×©×•××” × ×©××¨×” ×•× ×©×œ×—×” ×œ×¡× ×›×¨×•×Ÿ.</div>
    <div id="msgErr" class="msg msg-err"></div>

  </div>

  <!-- ×¨×©×•××•×ª -->
  <div class="records-wrap">
    <div class="records-title">×¨×©×•××•×ª ×©×”×•×–× ×• ××”××›×©×™×¨ ×”×–×”</div>
    <div id="recordsList"></div>
  </div>

</div>

<script>
  // ===== ×”×’×“×¨×•×ª =====
  const API_URL   = 'https://script.google.com/macros/s/AKfycbzUHeV_5NdOwymZ5QbHJMsWT-jd9nwV1BV5sNbJbbjEwytSFMJfsCZSOO-NRZDbxz0/exec'; // ×œ×©×™× ××ª ×”-URL ×©×œ×š
  const ADMIN_CODE = '2100';
  const SHEET_URL  = 'https://docs.google.com/spreadsheets/d/1bDLu3qPGn2v8ofWxtn7D3eMHwYwfaWRwollzgJfGTPc/edit?gid=0#gid=0'; // ××•×¤×¦×™×•× ×œ×™

  const STORAGE_KEY = 'lfp_records_v4';
  const OWNER_KEY   = 'lfp_owner_id_v1';

  let records = [];
  let ownerId = null;
  let editingId = null;
  let currentRating = 0;

  const E = id => document.getElementById(id);

  // ===== ×œ×•×— ×–×× ×™×: ××•×§×“ â†’ ×ª××¨×™×š + × ×¦×™×’×™× =====
  const FAIR_SCHEDULE = [
    { centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×¨×™×™×›××Ÿ",            date:"2025-12-01", agents:["×™×¢×§×‘","××•×¤×™×¨","×©×§×“","×’×œ"] },
    { centerName:"(×¡×™××•×œ×¦×™×™×ª ×©×•×ª×¤×™× ×œ×“×¨×š)",     date:"2025-12-02", agents:["××•×¨×™","××™×ª×™ ×©×’×‘","×¦×™×•× ×”"] },
    { centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×‘×¨ ××™×œ×Ÿ",          date:"2025-12-03", agents:["××™×œ×•×Ÿ","×™×¢×§×‘","××œ×™××‘","×‘×™×¡××Ÿ"] },
    { centerName:"××•× ×™×‘×¨×¡×™×˜×ª ×ª×œ-××‘×™×‘",          date:"2025-12-04", agents:["××•×¨×™","××•×¤×™×¨","×¦×œ×™×œ"] },
    { centerName:"××›×œ×œ×ª ×©×¢×¨×™ ××“×¢ ×•××©×¤×˜",         date:"2025-12-08", agents:["××•×¨×™","××•×¤×™×¨","×¦×œ×™×œ"] },
    { centerName:"×©×•×ª×¤×™× ×œ×“×¨×š",                 date:"2025-12-08", agents:["××™×ª×™*","×¦×™×•× ×”*"] },
    { centerName:"××›×œ×œ×ª ×¡×¤×™×¨",                   date:"2025-12-09", agents:["×‘×§×™","××™×ª×™"] },
    { centerName:"×”××›×œ×œ×” ×œ×× ×”×œ ×¨××©×œ\"×¦",         date:"2025-12-25", agents:["××•×¨×™","×¦×™×•× ×”","××•×¤×™×¨"] },
    { centerName:"×”××•× ×™×‘×¨×¡×™×˜×” ×”×¢×‘×¨×™×ª",          date:"2025-12-28", agents:["××•×¨×™","××œ×™××‘"] }
  ];

  function initOwner(){
    ownerId = localStorage.getItem(OWNER_KEY);
    if(!ownerId){
      ownerId = 'u_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
      localStorage.setItem(OWNER_KEY, ownerId);
    }
  }

  // ===== ×˜×œ×¤×•×Ÿ â€“ ×œ××¤×©×¨ ×¨×§ ×¡×¤×¨×•×ª, ×œ×”×’×‘×™×œ ×œ-10 =====
  E('phone').addEventListener('input', () => {
    const digits = E('phone').value.replace(/\D/g,'').slice(0,10);
    E('phone').value = digits;
  });

  // ===== ×›×•×›×‘×™× =====
  function updateStars(v){
    currentRating = v;
    document.querySelectorAll('#stars .star').forEach(s=>{
      const val = Number(s.dataset.val);
      s.classList.toggle('filled', val<=v);
    });
  }
  document.querySelectorAll('#stars .star').forEach(s=>{
    s.addEventListener('click',()=>updateStars(Number(s.dataset.val)));
  });

  // ===== ×¦'×™×¤×™× =====
  document.querySelectorAll('.trait-chip').forEach(ch=>{
    ch.addEventListener('click',()=>ch.classList.toggle('active'));
  });
  
  // ===== ×‘×—×™×¨×ª ××•×§×“ â†’ ×ª××¨×™×š + ×¨×©×™××ª × ×¦×™×’×™× =====
  function onCenterChange(){
    const val = E('center').value;
    const slot = FAIR_SCHEDULE.find(s=>s.centerName===val);
    // ×ª××¨×™×š
    if(slot){
      E('date').value = slot.date;
      // × ×¦×™×’×™×
      const agentSel = E('agent');
      agentSel.innerHTML = '<option value="">×‘×—×¨ × ×¦×™×’</option>';
      slot.agents.forEach(a=>{
        const clean = a.replace('*','').trim();
        const opt = document.createElement('option');
        opt.value = clean;
        opt.textContent = clean;
        agentSel.appendChild(opt);
      });
    }else{
      E('date').value = '';
      E('agent').innerHTML = '<option value="">×‘×—×¨ × ×¦×™×’</option>';
    }
  }
  E('center').addEventListener('change', onCenterChange);

  // ===== ×•×œ×™×“×¦×™×” =====
  function clearErrors(){
    ['center','agent','phone','email'].forEach(id=>E(id).classList.remove('error'));
    E('msgErr').style.display='none';
    E('msgOk').style.display='none';
  }

  function isValidPhone(p){
    const d = (p||'').replace(/\D/g,'');
    return !d || d.length===9 || d.length===10;
  }

  function isValidEmail(e){
    if(!e) return true;
    const re=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(e);
  }

  // ===== ×©××™×¨×” / ×¢×“×›×•×Ÿ =====
   // ===== ×©××™×¨×” / ×¢×“×›×•×Ÿ =====
  async function saveRecord(){
    clearErrors();

    const center = E('center').value.trim();
    const agent  = E('agent').value.trim();
    const date   = E('date').value;

    const name   = E('name').value.trim();
    const year   = E('year').value;
    const city   = E('city').value.trim();
    const phone  = E('phone').value.trim();
    const email  = E('email').value.trim();
    const field  = E('field').value;
    const impression = E('impression').value.trim();
    const notes      = E('notes').value.trim();

    const traits = Array.from(
      document.querySelectorAll('.trait-chip.active')
    ).map(ch=>ch.dataset.t);

    const errors = [];
    if(!center){errors.push('×™×© ×œ×‘×—×•×¨ ××•×§×“.');E('center').classList.add('error');}
    if(!agent){errors.push('×™×© ×œ×‘×—×•×¨ × ×¦×™×’.');E('agent').classList.add('error');}
    if(!isValidPhone(phone)){errors.push('××¡×¤×¨ ×”×˜×œ×¤×•×Ÿ ××™× ×• ×ª×§×™×Ÿ.');E('phone').classList.add('error');}
    if(!isValidEmail(email)){errors.push('×›×ª×•×‘×ª ×”××™×™×œ ××™× ×” ×ª×§×™× ×”.');E('email').classList.add('error');}

    if(errors.length){
      E('msgErr').textContent = errors.join(' ');
      E('msgErr').style.display='block';
      return;
    }

   // ×§×•×“ ××ª×•×§×Ÿ (×”×¢×ª×§ ×•×”×“×‘×§ ×‘××§×•× ×”×‘×œ×•×§ ×”×§×•×“×)

Â  Â  const id = editingId || ('r_'+Date.now()+'_'+Math.random().toString(36).slice(2,7));

    // *** ×ª×—×™×œ×ª ×”×•×¡×¤×” ***
    // ××—×©×‘ ××ª ×”×©×¢×” ×”× ×•×›×—×™×ª ×•×××™×¨ ××•×ª×” ×œ××—×¨×•×–×ª (×œ×“×•×’××”: "13:41")
    const now = new Date();
    const time = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
    // *** ×¡×•×£ ×”×•×¡×¤×” ***

Â  Â  const rec = {
Â  Â  Â  id, ownerId,
Â  Â  Â  center, agent, date,
      // *** ×”×•×¡×£ ××ª ×”×©×¢×” ×›××Ÿ ***
Â  Â  Â  time,
      // *** ×¡×•×£ ×”×•×¡×¤×” ***
Â  Â  Â  name, year, city, phone, email, field,
Â  Â  Â  rating:currentRating, traits, impression, notes
Â  Â  };

    // ×¢×“×›×•×Ÿ ×‘××¢×¨×š / ×—×“×©
    const idx = records.findIndex(r=>r.id===id);
    if(idx>=0) records[idx]=rec;
    else records.push(rec);
    persistRecords();
    renderRecords();

    // ×©×œ×™×—×” ×œ×¡×§×¨×™×¤×˜ (×”×•×¡×¤×”/×¢×“×›×•×Ÿ â€“ action:add)
    try{
      if(API_URL && API_URL.includes('script.google.com')){
        const res = await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({action:'add',ownerId,record:rec})
        });
        const txt = await res.text();
        console.log('API response:', res.status, txt);
      }
      E('msgOk').textContent = '×”×¨×©×•××” × ×©××¨×” ×•× ×©×œ×—×” ×œ×¡× ×›×¨×•×Ÿ.';
      E('msgOk').style.display='block';
    }catch(err){
      console.error('sync error:', err);
      E('msgErr').textContent = '×”×¨×©×•××” × ×©××¨×” ××§×•××™×ª, ××š ×”×¡× ×›×¨×•×Ÿ × ×›×©×œ.';
      E('msgErr').style.display='block';
    }

    clearForm(false);
  }

  function clearForm(resetHeader=true){
    if(resetHeader){
      E('center').value='';
      E('agent').innerHTML='<option value="">×‘×—×¨ × ×¦×™×’</option>';
      E('date').value='';
    }
    ['name','year','city','phone','email','field','impression','notes'].forEach(id=>E(id).value='');
    document.querySelectorAll('.trait-chip').forEach(ch=>ch.classList.remove('active'));
    updateStars(0);
    editingId=null;
    clearErrors();
  }

  // ===== ×¨×©×•××•×ª ×‘×œ×•×§××œ×¡×˜×•×¨×’' =====
  function loadRecords(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      records = raw ? JSON.parse(raw) : [];
    }catch{
      records=[];
    }
  }
  function persistRecords(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
  }

  function renderRecords(){
    const box = E('recordsList');
    box.innerHTML='';
    const mine = records.filter(r=>r.ownerId===ownerId);
    if(!mine.length){
      box.innerHTML='<div style="font-size:.78rem;color:#9ca3af;">××™×Ÿ ×¨×©×•××•×ª ×œ×”×¦×’×”.</div>';
      return;
    }
    mine.forEach(r=>{
      const div = document.createElement('div');
      div.className='record-card';
      div.innerHTML = `
        <div class="record-header">
          <div>
            <strong>${r.name || '×œ×œ× ×©×'}</strong>
            <div class="record-meta">${r.center || ''} Â· ${r.agent || ''}</div>
          </div>
          <div class="record-actions">
            <button class="icon-btn edit" data-id="${r.id}">âœ ×¢×¨×•×š</button>
            <button class="icon-btn del" data-id="${r.id}">ğŸ—‘ ××—×§</button>
          </div>
        </div>
        <div class="record-meta">
          ×ª××¨×™×š: ${r.date || '-'} Â· ×˜×œ×¤×•×Ÿ: ${r.phone || '-'} Â· ××™×™×œ: ${r.email || '-'}
        </div>
      `;
      box.appendChild(div);
    });

    // ××™×¨×•×¢×™ ×¢×¨×™×›×” / ××—×™×§×”
    box.querySelectorAll('.icon-btn.edit').forEach(btn=>{
      btn.addEventListener('click',()=>startEdit(btn.dataset.id));
    });
    box.querySelectorAll('.icon-btn.del').forEach(btn=>{
      btn.addEventListener('click',()=>deleteRecord(btn.dataset.id));
    });
  }

  function startEdit(id){
    const r = records.find(x=>x.id===id);
    if(!r) return;
    editingId = id;

    E('center').value=r.center||'';
    onCenterChange(); // ×™××œ× ×ª××¨×™×š ×•× ×¦×™×’×™×
    E('agent').value=r.agent||'';
    E('date').value=r.date||'';

    E('name').value=r.name||'';
    E('year').value=r.year||'';
    E('city').value=r.city||'';
    E('phone').value=r.phone||'';
    E('email').value=r.email||'';
    E('field').value=r.field||'';
    E('impression').value=r.impression||'';
    E('notes').value=r.notes||'';

    document.querySelectorAll('.trait-chip').forEach(ch=>{
      const t = ch.dataset.t;
      ch.classList.toggle('active', (r.traits||[]).includes(t));
    });
    updateStars(r.rating||0);
    window.scrollTo({top:0,behavior:'smooth'});
  }

  async function deleteRecord(id){
    const r = records.find(x=>x.id===id);
    if(!r) return;
    if(!confirm('×œ××—×•×§ ××ª ×”×¨×©×•××”? ×”×™× ×ª×¡×•××Ÿ ×›××—×•×§×” ×‘×’×™×œ×™×•×Ÿ.')) return;

    records = records.filter(x=>x.id!==id);
    persistRecords();
    renderRecords();

    try{
      if(API_URL && API_URL.includes('script.google.com')){
        await fetch(API_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({action:'delete',ownerId,record:r})
        });
      }
    }catch(err){
      // ×× × ×›×©×œ â€“ ×œ× × ×•×¨×, ×™×© ×¢×•×ª×§ ××§×•××™
    }
  }

  // ===== ×›×¤×ª×•×¨×™× ×¢×œ×™×•× ×™× =====
  E('btnTopClear').addEventListener('click',()=>clearForm(true));

  E('btnOpenRecords').addEventListener('click',()=>{
    const el = E('recordsList');
    if(el) el.scrollIntoView({behavior:'smooth'});
  });

  E('btnExportAdmin').addEventListener('click',()=>{
    const code = prompt('×”×›× ×¡ ×§×•×“ ××•×¨×©×”:');
    if(code===ADMIN_CODE){
      if(SHEET_URL.startsWith('http')){
        window.open(SHEET_URL,'_blank');
      }else{
        alert('×¢×“×›×Ÿ ××ª SHEET_URL ×‘×§×•×“ ×¢×œ ×× ×ª ×œ×¤×ª×•×— ××ª ×”×’×™×œ×™×•×Ÿ.');
      }
    }else if(code){
      alert('×§×•×“ ×©×’×•×™.');
    }
  });

  // ===== ××™×¤×•×¡ ×”×•×“×¢×•×ª =====
  E('btnClear').addEventListener('click',()=>clearForm(true));
  E('btnSave').addEventListener('click',saveRecord);

  // ===== INIT =====
  (function init(){
    initOwner();
    loadRecords();
    renderRecords();
  })();
</script>
</body>
</html>
